<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas.com - Login</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <!-- Firebase v8 compatible con firebase.auth() y firebase.firestore() -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>

<style>
    :root {
    /* Variables principales que faltan */
    --bg-black: #0F0F0F;
    --text-white: #FFFFFF;
    --success-green: #4CAF50;
    --error-red: #F44336;
    --warning-yellow: #FFC107;
    
    /* Colores mejorados */
    --primary-orange: #FF8C42;
    --hover-orange: #FF7A2B;
    --accent-orange: #FFA366;
    --dark-orange: #E67A35;
    
    /* Tonos c√°lidos en lugar de grises */
    --warm-gray: #2A2A2A;
    --light-warm: #363636;
    --card-warm: #1F1F1F;
    --border-warm: #404040;
    --secondary-gray: #AAA;
    
    /* Gradientes */
    --gradient-card: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
    --gradient-orange: linear-gradient(135deg, #FF8C42 0%, #FFA366 100%);
    --gradient-dark: linear-gradient(135deg, #0F0F0F 0%, #1F1F1F 100%);
    
    /* Actualizar variables existentes */
    --card-bg: var(--gradient-card);
    --border-color: var(--border-warm);
    --input-bg: var(--warm-gray);
    --shadow-dark: rgba(0, 0, 0, 0.3);
    --shadow-orange: rgba(255, 140, 66, 0.2);
}
</style>

<body>
    <div id="recaptcha-container" style="display: none;"></div>
    <div class="container">
        <!-- Language Toggle -->
        <div class="language-toggle">
            <button class="lang-btn" onclick="changeLanguageLocal('es')" id="lang-es">ES</button>
            <button class="lang-btn" onclick="changeLanguageLocal('en')" id="lang-en">EN</button>
        </div>

        <!-- Main Login Container -->
        <div class="login-container">
            <!-- Logo -->
            <div class="logo-container">
                <img src="images/logo.png" alt="MisEstrellas Logo" class="logo">
                <h1 class="brand-name" data-translate="brand_name">MisEstrellas</h1>
            </div>

            <!-- User Type Selector -->
            <div class="user-type-selector">
                <button class="type-btn active" id="client-btn" onclick="selectUserType('client')" data-translate="client">Cliente</button>
                <button class="type-btn" id="admin-btn" onclick="selectUserType('admin')" data-translate="admin">Administrador</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="login-form">
                <!-- Client Login -->
                <div id="client-login" class="login-section active">
                    <div class="input-group">
                        <label data-translate="phone_or_email">Tel√©fono o Email</label>
                        <input type="tel" id="client-phone" placeholder="+57 300 123 4567" class="input-field">
                        <input type="email" id="client-email" placeholder="email@ejemplo.com" class="input-field" style="display: none;">
                        <button type="button" class="toggle-input" onclick="toggleClientInput()" data-translate="use_email">Usar Email</button>
                    </div>
                </div>

                <!-- Admin Login -->
                <div id="admin-login" class="login-section">
                    <div class="input-group">
                        <label data-translate="email">Email</label>
                        <input type="email" id="admin-email" placeholder="admin@negocio.com" class="input-field">
                    </div>
                    <div class="input-group">
                        <label data-translate="password">Contrase√±a</label>
                        <input type="password" id="admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input-field">
                    </div>
                </div>

                <!-- Verification Code (for clients) -->
                <div id="verification-section" class="login-section" style="display: none;">
                    <div class="input-group">
                        <label data-translate="verification_code">C√≥digo de verificaci√≥n</label>
                        <input type="text" id="verification-code" placeholder="123456" class="input-field">
                        <p class="verification-info" data-translate="verification_sent">C√≥digo enviado a tu tel√©fono/email</p>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="login-btn" data-translate="continue">Continuar</button>
            </form>

            <!-- Loading Spinner -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p data-translate="loading">Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <!-- Tu l√≥gica personalizada -->
    <script src="js/translations.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Initialize phone input
        let phoneInput;
        let currentUserType = 'client';
        let isUsingEmail = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializePhoneInput();
            updateTexts();
            setupEventListeners();
        });

        function initializePhoneInput() {
            const phoneField = document.getElementById('client-phone');
            phoneInput = window.intlTelInput(phoneField, {
                initialCountry: 'co',
                preferredCountries: ['co', 'us', 'mx'],
                utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js'
            });
        }

        function selectUserType(type) {
            currentUserType = type;
            
            // Update button states
            document.getElementById('client-btn').classList.toggle('active', type === 'client');
            document.getElementById('admin-btn').classList.toggle('active', type === 'admin');
            
            // Show/hide login sections
            document.getElementById('client-login').classList.toggle('active', type === 'client');
            document.getElementById('admin-login').classList.toggle('active', type === 'admin');
            
            // Hide verification section
            document.getElementById('verification-section').style.display = 'none';
            
            // Update button text
            const loginBtn = document.getElementById('login-btn');
            loginBtn.textContent = type === 'client' ? 'Continuar' : 'Iniciar sesi√≥n';
        }

        function toggleClientInput() {
            isUsingEmail = !isUsingEmail;
            const phoneField = document.getElementById('client-phone');
            const emailField = document.getElementById('client-email');
            const toggleBtn = document.querySelector('.toggle-input');
            
            if (isUsingEmail) {
                phoneField.style.display = 'none';
                emailField.style.display = 'block';
                toggleBtn.textContent = 'Usar Tel√©fono';
            } else {
                phoneField.style.display = 'block';
                emailField.style.display = 'none';
                toggleBtn.textContent = 'Usar Email';
            }
        }

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                if (currentUserType === 'client') {
                    await handleClientLogin();
                } else {
                    await handleAdminLogin();
                }
            } catch (error) {
                showError(error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function handleClientLogin() {
            const verificationSection = document.getElementById('verification-section');
            
            if (verificationSection.style.display === 'none') {
                // First step: send verification code
                const contact = isUsingEmail ? 
                    document.getElementById('client-email').value :
                    phoneInput.getNumber();
                
                if (!contact) {
                    throw new Error('Por favor ingresa tu tel√©fono o email');
                }
                
                console.log('üîç Verificando window.loginCliente:', typeof window.loginCliente);
                
                // üî• Variable para almacenar el resultado
                let result;
                
                // Verificar si la funci√≥n est√° disponible
                if (typeof window.loginCliente !== 'function') {
                    console.log('‚è≥ Esperando a que loginCliente est√© disponible...');
                    
                    // Esperar hasta 5 segundos
                    for (let i = 0; i < 50; i++) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        if (typeof window.loginCliente === 'function') {
                            console.log('‚úÖ loginCliente ahora est√° disponible');
                            break;
                        }
                    }
                    
                    // Si a√∫n no est√° disponible, usar funci√≥n local
                    if (typeof window.loginCliente !== 'function') {
                        console.log('‚ö†Ô∏è window.loginCliente no disponible, usando funci√≥n local');
                        result = await loginClienteLocal(contact);
                    } else {
                        // Usar la funci√≥n global
                        result = await window.loginCliente(contact);
                    }
                } else {
                    // Usar la funci√≥n global
                    result = await window.loginCliente(contact);
                }
                
                // üî• DESPU√âS DE OBTENER EL RESULTADO, MOSTRAR LA SECCI√ìN DE VERIFICACI√ìN
                console.log('üìß Resultado del env√≠o:', result);
                
                // Mostrar mensaje al usuario
                if (result && result.message) {
                    // Mostrar mensaje temporal
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        background: #4CAF50;
                        color: white;
                        padding: 12px;
                        border-radius: 8px;
                        margin: 10px 0;
                        text-align: center;
                        font-size: 14px;
                    `;
                    messageDiv.textContent = result.message;
                    
                    // Insertar mensaje antes del bot√≥n
                    const loginBtn = document.getElementById('login-btn');
                    loginBtn.parentNode.insertBefore(messageDiv, loginBtn);
                    
                    // Remover mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 3000);
                }
                
                // Mostrar secci√≥n de verificaci√≥n
                verificationSection.style.display = 'block';
                document.getElementById('login-btn').textContent = 'Verificar';
                
                console.log('‚úÖ Secci√≥n de verificaci√≥n mostrada');
                
            } else {
                // Second step: verify code
                const code = document.getElementById('verification-code').value;
                
                if (!code) {
                    throw new Error('Por favor ingresa el c√≥digo de verificaci√≥n');
                }
                
                console.log('üîç Verificando c√≥digo:', code);
                
                // Verificar c√≥digo
                let verificationResult;
                
                if (typeof window.verificarCodigo === 'function') {
                    verificationResult = await window.verificarCodigo(code);
                } else {
                    verificationResult = await verificarCodigoLocal(code);
                }
                
                console.log('‚úÖ C√≥digo verificado exitosamente:', verificationResult);
                
                // Mostrar mensaje de √©xito
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    background: #4CAF50;
                    color: white;
                    padding: 12px;
                    border-radius: 8px;
                    margin: 10px 0;
                    text-align: center;
                    font-size: 14px;
                `;
                successDiv.textContent = '‚úÖ Verificaci√≥n exitosa. Redirigiendo...';
                
                const loginBtn = document.getElementById('login-btn');
                loginBtn.parentNode.insertBefore(successDiv, loginBtn);
                
                // Esperar un momento y redirigir
                // Esperar un momento y redirigir
                setTimeout(() => {
                    console.log('üîÑ Redirigiendo a dashboard...');
                    // Redirigir directamente ya que tenemos usuario simulado
                    if (window.simulatedUser || (window.auth && window.auth.currentUser)) {
                        console.log('‚úÖ Usuario confirmado, redirigiendo...');
                        window.location.href = 'cliente/dashboard.html'; // Usar debug temporalmente
                    } else {
                        console.log('‚ö†Ô∏è Forzando redirecci√≥n...');
                        window.location.href = 'cliente/dashboard.html';
                    }
                }, 1500);
            }
        }

        // üî• Funci√≥n de respaldo para login cliente
        async function loginClienteLocal(contactInfo) {
            try {
                console.log('üîÑ Login cliente local iniciado para:', contactInfo);
                
                // Verificar que Firebase est√© disponible
                if (!window.auth || !window.db) {
                    throw new Error('Firebase no est√° inicializado');
                }
                
                if (isEmail(contactInfo)) {
                    // Email-based authentication for clients
                    return await authenticateClientWithEmailLocal(contactInfo);
                } else {
                    // Phone-based authentication
                    return await authenticateClientWithPhoneLocal(contactInfo);
                }
                
            } catch (error) {
                console.error('‚ùå Error en login cliente local:', error);
                throw error;
            }
        }

        // üî• Funci√≥n mejorada para manejo de SMS con modo de prueba
        async function authenticateClientWithPhoneLocal(phoneNumber) {
            try {
                console.log('üì± Autenticando con tel√©fono:', phoneNumber);
                
                // Format phone number
                const formattedPhone = formatPhoneNumber(phoneNumber);
                console.log('üì± Tel√©fono formateado:', formattedPhone);
                
                // üî• MODO DE PRUEBA - Simular env√≠o de SMS para desarrollo
                if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                    console.log('üß™ Modo de prueba activado - Simulando env√≠o de SMS');
                    
                    // Simular un resultado de confirmaci√≥n
                    window.confirmationResult = {
                        confirm: async function(code) {
                            console.log('üß™ Verificando c√≥digo de prueba:', code);
                            
                            // C√≥digos de prueba v√°lidos
                            const validTestCodes = ['123456', '000000', '111111'];
                            
                            if (validTestCodes.includes(code)) {
                                console.log('‚úÖ C√≥digo de prueba v√°lido');
                                
                                // Crear un usuario simulado
                                const testUser = {
                                    uid: 'XMfYVWEwk5a8bDCuK6dtfJ1c0Zj2', // Usar el UID real de las im√°genes
                                    phoneNumber: formattedPhone,
                                    email: null,
                                    displayName: 'Juan P√©rez Cliente',
                                    emailVerified: false
                                };
                                
                                return { user: testUser };
                            } else {
                                throw new Error('C√≥digo de verificaci√≥n inv√°lido');
                            }
                        }
                    };
                    
                    return {
                        success: true,
                        message: 'C√≥digo de verificaci√≥n enviado (MODO PRUEBA - usa: 123456)',
                        requiresVerification: true
                    };
                }
                
                // üî• MODO PRODUCCI√ìN - Usar Firebase SMS real
                try {
                    if (!window.recaptchaVerifier) {
                        // Create invisible reCAPTCHA
                        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                            'size': 'invisible',
                            'callback': function(response) {
                                console.log('‚úÖ reCAPTCHA verificado');
                            },
                            'expired-callback': function() {
                                console.log('‚ö†Ô∏è reCAPTCHA expirado');
                            }
                        });
                    }
                    
                    // Send SMS verification code
                    window.confirmationResult = await window.auth.signInWithPhoneNumber(
                        formattedPhone, 
                        window.recaptchaVerifier
                    );
                    
                    console.log('‚úÖ SMS enviado a:', formattedPhone);
                    return {
                        success: true,
                        message: 'C√≥digo de verificaci√≥n enviado',
                        requiresVerification: true
                    };
                    
                } catch (recaptchaError) {
                    console.error('‚ùå Error con reCAPTCHA:', recaptchaError);
                    
                    // Reset reCAPTCHA on error
                    if (window.recaptchaVerifier) {
                        window.recaptchaVerifier.clear();
                        window.recaptchaVerifier = null;
                    }
                    
                    // Si falla reCAPTCHA, usar modo de prueba como fallback
                    console.log('üß™ Fallback: Activando modo de prueba por error de reCAPTCHA');
                    
                    window.confirmationResult = {
                        confirm: async function(code) {
                            if (code === '123456') {
                                const testUser = {
                                    uid: 'test_user_' + Date.now(),
                                    phoneNumber: formattedPhone,
                                    email: null,
                                    displayName: null,
                                    emailVerified: false
                                };
                                return { user: testUser };
                            } else {
                                throw new Error('C√≥digo de verificaci√≥n inv√°lido');
                            }
                        }
                    };
                    
                    return {
                        success: true,
                        message: 'C√≥digo de verificaci√≥n enviado (MODO PRUEBA - usa: 123456)',
                        requiresVerification: true
                    };
                }
                
            } catch (error) {
                console.error('‚ùå Error en autenticaci√≥n por tel√©fono:', error);
                throw new Error('Error enviando c√≥digo SMS: ' + error.message);
            }
        }

        // üî• Funci√≥n mejorada para verificar c√≥digo
        async function verificarCodigoLocal(verificationCode) {
            try {
                console.log('üîç Verificando c√≥digo:', verificationCode);
                
                if (window.confirmationResult) {
                    // Phone verification (real o modo prueba)
                    const result = await window.confirmationResult.confirm(verificationCode);
                    console.log('‚úÖ Verificaci√≥n exitosa');
                    
                    // Create or update user profile
                    if (result && result.user) {
                        await createOrUpdateClientProfileLocal(result.user);
                        console.log('‚úÖ Perfil de usuario creado/actualizado');
                        
                        // üî• FORZAR AUTENTICACI√ìN PARA USUARIOS DE PRUEBA
                        if (result.user.uid.startsWith('test_user_') || result.user.uid === 'XMfYVWEwk5a8bDCuK6dtfJ1c0Zj2') {
                            console.log('üß™ Simulando autenticaci√≥n persistente...');
                            
                            // Crear un objeto de usuario simulado m√°s completo
                            const persistentUser = {
                                uid: 'XMfYVWEwk5a8bDCuK6dtfJ1c0Zj2',
                                phoneNumber: '+573155555555',
                                email: null,
                                displayName: 'Juan P√©rez Cliente',
                                emailVerified: false,
                                isAnonymous: false,
                                metadata: {
                                    creationTime: new Date().toISOString(),
                                    lastSignInTime: new Date().toISOString()
                                }
                            };
                            
                            // Simular que el usuario est√° autenticado globalmente
                            window.simulatedUser = persistentUser;
                            localStorage.setItem('simulatedUser', JSON.stringify(persistentUser));
                            
                            console.log('‚úÖ Usuario simulado guardado:', persistentUser.uid);
                        }
                        
                        // Verificar que el usuario est√© realmente autenticado
                        console.log('üîç Verificando autenticaci√≥n antes de redirigir...');
                        console.log('Current user:', window.auth.currentUser ? window.auth.currentUser.uid : 'none');
                        console.log('Simulated user:', window.simulatedUser ? window.simulatedUser.uid : 'none');
                        
                    } else {
                        console.log('‚ö†Ô∏è No se pudo crear perfil - resultado inv√°lido');
                    }
                    
                    return {
                        success: true,
                        user: result.user
                    };
                } else {
                    throw new Error('No hay proceso de verificaci√≥n en curso');
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando c√≥digo:', error);
                throw new Error('C√≥digo inv√°lido: ' + error.message);
            }
        }

        // üî• Funci√≥n mejorada para crear/actualizar perfil de cliente
        async function createOrUpdateClientProfileLocal(user) {
            try {
                console.log('üë§ Creando/actualizando perfil para:', user.uid);
                
                // Verificar si es usuario de prueba
                const isTestUser = user.uid.startsWith('test_user_');
                
                if (isTestUser) {
                    console.log('üß™ Usuario de prueba - saltando creaci√≥n en Firestore');
                    // Para usuarios de prueba, NO crear en Firestore
                    // Solo simular √©xito para que el flujo contin√∫e
                    return;
                }
                
                // Solo para usuarios reales, usar Firestore
                if (!window.db) {
                    console.log('‚ö†Ô∏è Firestore no disponible');
                    return;
                }
                
                const userDoc = await window.db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    // Update existing profile
                    await window.db.collection('users').doc(user.uid).update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        emailVerified: user.emailVerified,
                        phoneVerified: !!user.phoneNumber
                    });
                    console.log('‚úÖ Perfil actualizado');
                } else {
                    // Create new client profile
                    await window.db.collection('users').doc(user.uid).set({
                        name: user.displayName || user.phoneNumber || 'Usuario',
                        email: user.email || null,
                        phoneNumber: user.phoneNumber,
                        phoneVerified: !!user.phoneNumber,
                        emailVerified: user.emailVerified || false,
                        userType: 'client',
                        totalPoints: 0,
                        totalVisits: 0,
                        totalRedemptions: 0,
                        joinedBusinesses: [],
                        isActive: true,
                        displayName: user.displayName || user.phoneNumber || 'Usuario',
                        preferences: {
                            language: 'es',
                            notifications: true,
                            theme: 'light'
                        },
                        registrationSource: 'phone',
                        analytics: {
                            averagePointsPerVisit: 0
                        },
                        avatar: '',
                        location: {
                            city: 'Cali',
                            coordinates: {}
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Perfil creado');
                }
                
            } catch (error) {
                console.error('‚ùå Error managing client profile:', error);
                // No lanzar error para no bloquear el flujo
                console.log('‚ö†Ô∏è Continuando sin crear perfil en Firestore');
            }
        }

        function formatPhoneNumber(phoneNumber) {
            // Remove all non-digit characters
            let cleaned = phoneNumber.replace(/\D/g, '');
            
            // Add country code if not present (default to Colombia +57)
            if (!cleaned.startsWith('57') && cleaned.length === 10) {
                cleaned = '57' + cleaned;
            }
            
            // Add '+' prefix
            return '+' + cleaned;
        }

        function isEmail(input) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(input);
        }

        function generateTempPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            
            for (let i = 0; i < 16; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return password;
        }

        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (!email || !password) {
                throw new Error('Email y contrase√±a son requeridos');
            }

            console.log('üîç Verificando window.loginAdmin:', typeof window.loginAdmin);

            // Verificar si la funci√≥n est√° disponible
            if (typeof window.loginAdmin !== 'function') {
                console.log('‚è≥ Esperando a que loginAdmin est√© disponible...');
                
                for (let i = 0; i < 50; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (typeof window.loginAdmin === 'function') {
                        console.log('‚úÖ loginAdmin ahora est√° disponible');
                        break;
                    }
                }
                
                if (typeof window.loginAdmin !== 'function') {
                    console.log('‚ö†Ô∏è window.loginAdmin no disponible, usando funci√≥n local');
                    return await loginAdminLocal(email, password);
                }
            }

            // Usar la funci√≥n global
            const result = await window.loginAdmin(email, password);
            console.log('‚úÖ Login exitoso:', result);
            window.location.href = 'admin/dashboard.html';
        }

        // Funci√≥n de respaldo para admin (la que ya ten√≠as)
        async function loginAdminLocal(email, password) {
            try {
                console.log('üîÑ Login local iniciado para:', email);
                
                if (!window.auth || !window.db) {
                    throw new Error('Firebase no est√° inicializado');
                }
                
                const userCredential = await window.auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Autenticaci√≥n Firebase exitosa, UID:', userCredential.user.uid);
                
                const userDoc = await window.db.collection('users').doc(userCredential.user.uid).get();
                
                if (!userDoc.exists) {
                    console.log('‚ùå El documento no existe en Firestore');
                    await window.auth.signOut();
                    throw new Error('Usuario no encontrado en la base de datos');
                }

                const userData = userDoc.data();
                const userType = userData.userType;
                const cleanUserType = userType.toString().replace(/['"]/g, '').trim();
                
                if (!cleanUserType || cleanUserType !== 'admin') {
                    console.log('üö´ No es admin, valor limpio:', cleanUserType);
                    await window.auth.signOut();
                    throw new Error('Acceso no autorizado. Solo administradores pueden acceder');
                }

                console.log('üéâ Admin autenticado correctamente');
                console.log('üîÑ Redirigiendo a dashboard...');
                window.location.href = 'admin/dashboard.html';
                
                return {
                    success: true,
                    user: userCredential.user,
                    profile: userData
                };
                
            } catch (error) {
                console.error('‚ùå Error en login local:', error);
                throw error;
            }
        }

        function showError(message) {
            alert(message);
        }

        // üî• REEMPLAZAR POR ESTA FUNCI√ìN MEJORADA:
        function updateTexts() {
            console.log('üåê Actualizando textos...');
            
            // Verificar si translations.js est√° cargado
            if (typeof window.t !== 'function') {
                console.warn('‚ö†Ô∏è Funci√≥n de traducci√≥n no disponible, usando fallback');
                updateTextsWithFallback();
                return;
            }
            
            try {
                const currentLang = getLanguageLocal();
                console.log('üåç Idioma actual:', currentLang);
                
                // Update all elements with data-translate attribute
                const elements = document.querySelectorAll('[data-translate]');
                console.log('üîÑ Actualizando', elements.length, 'elementos');
                
                elements.forEach(element => {
                    const key = element.getAttribute('data-translate');
                    const translation = window.t(key);
                    
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'email' || element.type === 'tel')) {
                        // Update placeholder for input elements
                        element.placeholder = translation;
                    } else if (element.tagName === 'BUTTON' || element.tagName === 'SPAN' || element.tagName === 'P' || element.tagName === 'H1' || element.tagName === 'H2' || element.tagName === 'LABEL') {
                        // Update text content for other elements
                        element.textContent = translation;
                    }
                    
                    console.log('‚úÖ Traducido:', key, '‚Üí', translation);
                });
                
                // Update language buttons
                updateLanguageButtonsLocal();
                
                console.log('‚úÖ Traducciones aplicadas exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error aplicando traducciones:', error);
                updateTextsWithFallback();
            }
        }

        // üî• FUNCI√ìN PARA OBTENER IDIOMA LOCAL (sin conflictos)
        function getLanguageLocal() {
            try {
                // Si existe la funci√≥n global, usarla SOLO si no estamos en un bucle
                if (typeof window.getCurrentLanguage === 'function' && window.getCurrentLanguage !== getLanguageLocal) {
                    return window.getCurrentLanguage();
                } else {
                    // Usar localStorage directamente
                    return localStorage.getItem('lang') || 'es';
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error obteniendo idioma:', error);
                return 'es';
            }
        }

        // üî• FUNCI√ìN PARA ACTUALIZAR BOTONES DE IDIOMA LOCAL
        function updateLanguageButtonsLocal() {
            try {
                const currentLang = getLanguageLocal();
                
                // Update language toggle buttons
                const langButtons = document.querySelectorAll('.lang-btn');
                langButtons.forEach(btn => {
                    const btnLang = btn.id.replace('lang-', '');
                    btn.classList.toggle('active', btnLang === currentLang);
                });
                
                console.log('üîÑ Botones de idioma actualizados para:', currentLang);
            } catch (error) {
                console.error('‚ùå Error actualizando botones de idioma:', error);
            }
        }

        // üî• FUNCI√ìN PARA CAMBIAR IDIOMA (evita conflictos)
        function changeLanguageLocal(lang) {
            try {
                console.log('üåç Cambiando idioma a:', lang);
                
                // Usar la funci√≥n global si est√° disponible
                if (typeof window.changeLanguage === 'function') {
                    window.changeLanguage(lang);
                } else {
                    // Fallback: cambiar manualmente
                    localStorage.setItem('lang', lang);
                    updateLanguageButtonsLocal();
                    updateTexts();
                }
                
                console.log('‚úÖ Idioma cambiado a:', lang);
            } catch (error) {
                console.error('‚ùå Error cambiando idioma:', error);
                // Fallback b√°sico
                localStorage.setItem('lang', lang);
                updateLanguageButtonsLocal();
                updateTexts();
            }
        }

        // üî• FUNCI√ìN DE TRADUCCI√ìN LOCAL CON FALLBACK
        function tLocal(key) {
            try {
                if (typeof window.t === 'function') {
                    return window.t(key);
                } else {
                    return getBasicTranslation(key);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en traducci√≥n para:', key);
                return getBasicTranslation(key);
            }
        }

        // üî• TRADUCCIONES B√ÅSICAS DE RESPALDO
        function getBasicTranslation(key) {
            const lang = getLanguageLocal();
            
            const basicTranslations = {
                es: {
                    'brand_name': 'MisEstrellas',
                    'client': 'Cliente', 
                    'admin': 'Administrador',
                    'phone_or_email': 'Tel√©fono o Email',
                    'email': 'Email',
                    'password': 'Contrase√±a',
                    'verification_code': 'C√≥digo de verificaci√≥n',
                    'verification_sent': 'C√≥digo enviado a tu tel√©fono/email',
                    'use_email': 'Usar Email',
                    'continue': 'Continuar',
                    'loading': 'Cargando...',
                    'login': 'Iniciar sesi√≥n'
                },
                en: {
                    'brand_name': 'MyStars',
                    'client': 'Client', 
                    'admin': 'Administrator',
                    'phone_or_email': 'Phone or Email',
                    'email': 'Email',
                    'password': 'Password',
                    'verification_code': 'Verification code',
                    'verification_sent': 'Code sent to your phone/email',
                    'use_email': 'Use Email',
                    'continue': 'Continue',
                    'loading': 'Loading...',
                    'login': 'Sign in'
                }
            };
            
            return basicTranslations[lang]?.[key] || basicTranslations['es']?.[key] || key;
        }

        // üî• FUNCI√ìN DE ACTUALIZACI√ìN CON FALLBACK B√ÅSICO
        function updateTextsWithFallback() {
            console.log('üîÑ Usando traducciones de respaldo...');
            
            try {
                const elements = document.querySelectorAll('[data-translate]');
                
                elements.forEach(element => {
                    const key = element.getAttribute('data-translate');
                    const translation = getBasicTranslation(key);
                    
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'email' || element.type === 'tel')) {
                        element.placeholder = translation;
                    } else {
                        element.textContent = translation;
                    }
                });
                
                updateLanguageButtonsLocal();
                console.log('‚úÖ Traducciones b√°sicas aplicadas');
                
            } catch (error) {
                console.error('‚ùå Error en traducciones de respaldo:', error);
            }
        }

        // üî• INICIALIZACI√ìN SEGURA
        function initializeTranslations() {
            try {
                // Establecer idioma por defecto si no existe
                if (!localStorage.getItem('lang')) {
                    const browserLang = navigator.language || navigator.userLanguage;
                    const lang = browserLang.startsWith('en') ? 'en' : 'es';
                    localStorage.setItem('lang', lang);
                }
                
                // Actualizar textos y botones
                updateLanguageButtonsLocal();
                updateTexts();
                
                console.log('‚úÖ Sistema de traducciones inicializado');
            } catch (error) {
                console.error('‚ùå Error inicializando traducciones:', error);
            }
        }
    </script>
</body>
</html>