<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas.com - Login</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <!-- Firebase v8 compatible con firebase.auth() y firebase.firestore() -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>

<style>
    :root {
    /* Variables principales que faltan */
    --bg-black: #0F0F0F;
    --text-white: #FFFFFF;
    --success-green: #4CAF50;
    --error-red: #F44336;
    --warning-yellow: #FFC107;
    
    /* Colores mejorados */
    --primary-orange: #FF8C42;
    --hover-orange: #FF7A2B;
    --accent-orange: #FFA366;
    --dark-orange: #E67A35;
    
    /* Tonos c√°lidos en lugar de grises */
    --warm-gray: #2A2A2A;
    --light-warm: #363636;
    --card-warm: #1F1F1F;
    --border-warm: #404040;
    --secondary-gray: #AAA;
    
    /* Gradientes */
    --gradient-card: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
    --gradient-orange: linear-gradient(135deg, #FF8C42 0%, #FFA366 100%);
    --gradient-dark: linear-gradient(135deg, #0F0F0F 0%, #1F1F1F 100%);
    
    /* Actualizar variables existentes */
    --card-bg: var(--gradient-card);
    --border-color: var(--border-warm);
    --input-bg: var(--warm-gray);
    --shadow-dark: rgba(0, 0, 0, 0.3);
    --shadow-orange: rgba(255, 140, 66, 0.2);
}
</style>

<body>
    <div id="recaptcha-container" style="display: none;"></div>
    <div class="container">
        <!-- Language Toggle -->
        <div class="language-toggle">
            <button class="lang-btn" onclick="changeLanguageLocal('es')" id="lang-es">ES</button>
            <button class="lang-btn" onclick="changeLanguageLocal('en')" id="lang-en">EN</button>
        </div>

        <!-- Main Login Container -->
        <div class="login-container">
            <!-- Logo -->
            <div class="logo-container">
                <img src="images/logo.png" alt="MisEstrellas Logo" class="logo">
                <h1 class="brand-name" data-translate="brand_name">MisEstrellas</h1>
            </div>

            <!-- User Type Selector -->
            <div class="user-type-selector">
                <button class="type-btn active" id="client-btn" onclick="selectUserType('client')" data-translate="client">Cliente</button>
                <button class="type-btn" id="admin-btn" onclick="selectUserType('admin')" data-translate="admin">Administrador</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="login-form">
                <!-- Client Login -->
                <div id="client-login" class="login-section active">
                    <div class="input-group">
                        <label data-translate="phone_or_email">Tel√©fono o Email</label>
                        <input type="tel" id="client-phone" placeholder="+57 300 123 4567" class="input-field">
                        <input type="email" id="client-email" placeholder="email@ejemplo.com" class="input-field" style="display: none;">
                        <button type="button" class="toggle-input" onclick="toggleClientInput()" data-translate="use_email">Usar Email</button>
                    </div>
                </div>

                <!-- Admin Login -->
                <div id="admin-login" class="login-section">
                    <div class="input-group">
                        <label data-translate="email">Email</label>
                        <input type="email" id="admin-email" placeholder="admin@negocio.com" class="input-field">
                    </div>
                    <div class="input-group">
                        <label data-translate="password">Contrase√±a</label>
                        <input type="password" id="admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input-field">
                    </div>
                </div>

                <!-- Verification Code (for clients) -->
                <div id="verification-section" class="login-section" style="display: none;">
                    <div class="input-group">
                        <label data-translate="verification_code">C√≥digo de verificaci√≥n</label>
                        <input type="text" id="verification-code" placeholder="123456" class="input-field">
                        <p class="verification-info" data-translate="verification_sent">C√≥digo enviado a tu tel√©fono/email</p>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="login-btn" data-translate="continue">Continuar</button>
            </form>

            <!-- Loading Spinner -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p data-translate="loading">Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <!-- Tu l√≥gica personalizada -->
    <script src="js/translations.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        let currentUserType = 'client';
        let isUsingEmail = false;
        let phoneInput;
        let verificationAttempts = 0;
        const MAX_VERIFICATION_ATTEMPTS = 3;

        document.addEventListener('DOMContentLoaded', function() {
            initializePhoneInput();
            updateTexts();
            setupEventListeners();
            
            // Mostrar informaci√≥n de l√≠mites al usuario
            showRateLimitInfo();
        });

        // Mostrar informaci√≥n sobre l√≠mites
        function showRateLimitInfo() {
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = `
                background: #2196F3;
                color: white;
                padding: 12px;
                border-radius: 8px;
                margin: 20px;
                font-size: 14px;
                text-align: center;
            `;
            infoDiv.innerHTML = `
                ‚ÑπÔ∏è <strong>L√≠mites de seguridad:</strong><br>
                ‚Ä¢ M√°ximo 2 c√≥digos cada 5 minutos<br>
                ‚Ä¢ M√°ximo 3 intentos fallidos cada 15 minutos<br>
                ‚Ä¢ Los c√≥digos expiran en 5 minutos
            `;
            
            const container = document.querySelector('.login-container');
            container.insertBefore(infoDiv, container.firstChild);
            
            // Remover despu√©s de 10 segundos
            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.remove();
                }
            }, 10000);
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                if (currentUserType === 'client') {
                    await handleClientLogin();
                } else {
                    await handleAdminLogin();
                }
            } catch (error) {
                showError(error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function handleClientLogin() {
            const verificationSection = document.getElementById('verification-section');
            
            if (verificationSection.style.display === 'none') {
                // Primer paso: enviar c√≥digo de verificaci√≥n
                const contact = isUsingEmail ? 
                    document.getElementById('client-email').value :
                    phoneInput.getNumber();
                
                if (!contact) {
                    throw new Error('Por favor ingresa tu tel√©fono o email');
                }
                
                // Verificar l√≠mites antes de enviar
                const rateLimitCheck = window.checkRateLimit ? window.checkRateLimit(contact) : { allowed: true };
                if (!rateLimitCheck.allowed) {
                    throw new Error(rateLimitCheck.message);
                }
                
                console.log('üîç Enviando c√≥digo de verificaci√≥n REAL a:', contact);
                
                // Esperar a que las funciones est√©n disponibles
                if (typeof window.loginCliente !== 'function') {
                    console.log('‚è≥ Esperando funciones de autenticaci√≥n...');
                    
                    for (let i = 0; i < 50; i++) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        if (typeof window.loginCliente === 'function') {
                            console.log('‚úÖ Funciones de autenticaci√≥n cargadas');
                            break;
                        }
                    }
                    
                    if (typeof window.loginCliente !== 'function') {
                        throw new Error('Error de configuraci√≥n: funciones de autenticaci√≥n no disponibles');
                    }
                }
                
                // Usar funci√≥n real de autenticaci√≥n
                const result = await window.loginCliente(contact);
                
                console.log('üìß Resultado del env√≠o REAL:', result);
                
                // Mostrar mensaje al usuario
                if (result && result.message) {
                    showSuccessMessage(result.message);
                }
                
                // Mostrar secci√≥n de verificaci√≥n
                verificationSection.style.display = 'block';
                document.getElementById('login-btn').textContent = 'Verificar C√≥digo';
                
                // Reiniciar contador de intentos
                verificationAttempts = 0;
                updateVerificationUI();
                
                console.log('‚úÖ C√≥digo enviado, esperando verificaci√≥n');
                
            } else {
                // Segundo paso: verificar c√≥digo
                const code = document.getElementById('verification-code').value;
                
                if (!code) {
                    throw new Error('Por favor ingresa el c√≥digo de verificaci√≥n');
                }
                
                if (code.length !== 6) {
                    throw new Error('El c√≥digo debe tener 6 d√≠gitos');
                }
                
                console.log('üîç Verificando c√≥digo REAL:', code);
                
                try {
                    // Usar funci√≥n real de verificaci√≥n
                    const verificationResult = await window.verificarCodigo(code);
                    
                    console.log('‚úÖ C√≥digo verificado exitosamente:', verificationResult);
                    
                    // Mostrar mensaje de √©xito
                    showSuccessMessage('‚úÖ Verificaci√≥n exitosa. Redirigiendo...');
                    
                    // Esperar un momento y redirigir
                    setTimeout(() => {
                        console.log('üîÑ Redirigiendo a dashboard del cliente...');
                        window.location.href = 'cliente/dashboard.html';
                    }, 1500);
                    
                } catch (error) {
                    verificationAttempts++;
                    const remainingAttempts = MAX_VERIFICATION_ATTEMPTS - verificationAttempts;
                    
                    if (remainingAttempts > 0) {
                        throw new Error(`C√≥digo incorrecto. Te quedan ${remainingAttempts} intentos.`);
                    } else {
                        // Bloquear por un tiempo
                        verificationSection.style.display = 'none';
                        document.getElementById('login-btn').textContent = 'Continuar';
                        throw new Error('Demasiados intentos fallidos. Solicita un nuevo c√≥digo.');
                    }
                }
            }
        }

        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (!email || !password) {
                throw new Error('Email y contrase√±a son requeridos');
            }

            console.log('üîç Verificando admin con credenciales reales...');

            // Esperar a que las funciones est√©n disponibles
            if (typeof window.loginAdmin !== 'function') {
                console.log('‚è≥ Esperando funciones de admin...');
                
                for (let i = 0; i < 50; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (typeof window.loginAdmin === 'function') {
                        console.log('‚úÖ Funciones de admin cargadas');
                        break;
                    }
                }
                
                if (typeof window.loginAdmin !== 'function') {
                    throw new Error('Error de configuraci√≥n: funciones de admin no disponibles');
                }
            }

            // Usar funci√≥n real de admin
            const result = await window.loginAdmin(email, password);
            console.log('‚úÖ Admin autenticado exitosamente:', result);
            
            showSuccessMessage('‚úÖ Acceso autorizado. Redirigiendo...');
            
            setTimeout(() => {
                window.location.href = 'admin/dashboard.html';
            }, 1500);
        }

        function updateVerificationUI() {
            const remainingAttempts = MAX_VERIFICATION_ATTEMPTS - verificationAttempts;
            const verificationInfo = document.querySelector('.verification-info');
            
            if (verificationInfo && verificationAttempts > 0) {
                verificationInfo.textContent = `C√≥digo enviado a tu tel√©fono/email. Intentos restantes: ${remainingAttempts}`;
                
                if (remainingAttempts <= 1) {
                    verificationInfo.style.color = '#F44336';
                }
            }
        }

        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                background: #4CAF50;
                color: white;
                padding: 12px;
                border-radius: 8px;
                margin: 10px 0;
                text-align: center;
                font-size: 14px;
                font-weight: 500;
            `;
            messageDiv.textContent = message;
            
            const loginBtn = document.getElementById('login-btn');
            loginBtn.parentNode.insertBefore(messageDiv, loginBtn);
            
            // Remover mensaje despu√©s de 5 segundos
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: #F44336;
                color: white;
                padding: 12px;
                border-radius: 8px;
                margin: 10px 0;
                text-align: center;
                font-size: 14px;
                font-weight: 500;
            `;
            errorDiv.textContent = message;
            
            const loginBtn = document.getElementById('login-btn');
            loginBtn.parentNode.insertBefore(errorDiv, loginBtn);
            
            // Remover mensaje despu√©s de 5 segundos
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Mantener las dem√°s funciones que ya tienes
        function selectUserType(type) {
            currentUserType = type;
            
            // Update button states
            document.getElementById('client-btn').classList.toggle('active', type === 'client');
            document.getElementById('admin-btn').classList.toggle('active', type === 'admin');
            
            // Show/hide login sections
            document.getElementById('client-login').classList.toggle('active', type === 'client');
            document.getElementById('admin-login').classList.toggle('active', type === 'admin');
            
            // Hide verification section
            document.getElementById('verification-section').style.display = 'none';
            
            // Update button text
            const loginBtn = document.getElementById('login-btn');
            loginBtn.textContent = type === 'client' ? 'Continuar' : 'Iniciar sesi√≥n';
            
            // Reset verification attempts
            verificationAttempts = 0;
        }

        function toggleClientInput() {
            isUsingEmail = !isUsingEmail;
            const phoneField = document.getElementById('client-phone');
            const emailField = document.getElementById('client-email');
            const toggleBtn = document.querySelector('.toggle-input');
            
            if (isUsingEmail) {
                phoneField.style.display = 'none';
                emailField.style.display = 'block';
                toggleBtn.textContent = 'Usar Tel√©fono';
            } else {
                phoneField.style.display = 'block';
                emailField.style.display = 'none';
                toggleBtn.textContent = 'Usar Email';
            }
        }

        function initializePhoneInput() {
            const phoneField = document.getElementById('client-phone');
            phoneInput = window.intlTelInput(phoneField, {
                initialCountry: 'co',
                preferredCountries: ['co', 'us', 'mx'],
                utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js'
            });
        }

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Listener para detectar enter en el campo de verificaci√≥n
            document.getElementById('verification-code').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin(e);
                }
            });
            
            // Listener para limpiar mensajes de error al escribir
            document.getElementById('verification-code').addEventListener('input', function() {
                // Limpiar mensajes de error previos
                const errorMessages = document.querySelectorAll('[style*="background: #F44336"]');
                errorMessages.forEach(msg => msg.remove());
            });
        }

        // Funci√≥n para solicitar nuevo c√≥digo
        async function requestNewCode() {
            try {
                // Ocultar secci√≥n de verificaci√≥n
                document.getElementById('verification-section').style.display = 'none';
                document.getElementById('login-btn').textContent = 'Continuar';
                
                // Limpiar campo de c√≥digo
                document.getElementById('verification-code').value = '';
                
                // Reiniciar intentos
                verificationAttempts = 0;
                
                showSuccessMessage('Puedes solicitar un nuevo c√≥digo');
                
            } catch (error) {
                showError('Error solicitando nuevo c√≥digo: ' + error.message);
            }
        }

        // Funci√≥n para mostrar tiempo restante del c√≥digo
        function startCodeTimer() {
            let timeLeft = 300; // 5 minutos en segundos
            const timerDisplay = document.createElement('div');
            timerDisplay.style.cssText = `
                text-align: center;
                color: #666;
                font-size: 12px;
                margin-top: 8px;
            `;
            
            const verificationSection = document.getElementById('verification-section');
            verificationSection.appendChild(timerDisplay);
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `C√≥digo v√°lido por: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(timer);
                    timerDisplay.innerHTML = `
                        <span style="color: #F44336;">C√≥digo expirado.</span>
                        <button onclick="requestNewCode()" style="background: none; border: none; color: #2196F3; cursor: pointer; text-decoration: underline;">
                            Solicitar nuevo c√≥digo
                        </button>
                    `;
                }
            }, 1000);
        }

        // Exportar funciones necesarias
        window.requestNewCode = requestNewCode;
        window.selectUserType = selectUserType;
        window.toggleClientInput = toggleClientInput;

        console.log('üî• Sistema de login REAL configurado');
    </script>
</body>
</html>