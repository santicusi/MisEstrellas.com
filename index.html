<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Estrellas - Inicio</title>
    <meta name="description" content="Mis Estrellas - Plataforma de fidelización para acumular puntos y canjear recompensas. Regístrate, gana puntos y disfruta de beneficios exclusivos.">
    <meta name="keywords" content="mis estrellas, puntos, recompensas, fidelización, canjear puntos, programa de lealtad, beneficios">
    <meta name="author" content="Mis Estrellas">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph para redes sociales -->
    <meta property="og:title" content="Mis Estrellas - Plataforma de Puntos y Recompensas">
    <meta property="og:description" content="Acumula puntos y canjea recompensas increíbles en nuestra plataforma de fidelización">
    <meta property="og:image" content="https://misestrellas.co/images/logo.png">
    <meta property="og:url" content="https://misestrellas.co">
    <meta property="og:type" content="website">
    
    <!-- Schema.org para Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Mis Estrellas",
      "url": "https://misestrellas.co",
      "description": "Plataforma de fidelización para acumular puntos y canjear recompensas",
      "applicationCategory": "LoyaltyProgram",
      "operatingSystem": "Web"
    }
    </script>
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://misestrellas.co">


    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css">
    <!-- Firebase v8 compatible con firebase.auth() y firebase.firestore() -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>



    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Para dispositivos Apple -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Para Android -->
    <link rel="manifest" href="/site.webmanifest">
</head>

<style>
    :root {
    /* Variables principales que faltan */
    --bg-black: #0F0F0F;
    --text-white: #FFFFFF;
    --success-green: #4CAF50;
    --error-red: #F44336;
    --warning-yellow: #FFC107;
    
    /* Colores mejorados */
    --primary-orange: #FF8C42;
    --hover-orange: #FF7A2B;
    --accent-orange: #FFA366;
    --dark-orange: #E67A35;
    
    /* Tonos cálidos en lugar de grises */
    --warm-gray: #2A2A2A;
    --light-warm: #363636;
    --card-warm: #1F1F1F;
    --border-warm: #404040;
    --secondary-gray: #AAA;
    
    /* Gradientes */
    --gradient-card: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
    --gradient-orange: linear-gradient(135deg, #FF8C42 0%, #FFA366 100%);
    --gradient-dark: linear-gradient(135deg, #0F0F0F 0%, #1F1F1F 100%);
    
    /* Actualizar variables existentes */
    --card-bg: var(--gradient-card);
    --border-color: var(--border-warm);
    --input-bg: var(--warm-gray);
    --shadow-dark: rgba(0, 0, 0, 0.3);
    --shadow-orange: rgba(255, 140, 66, 0.2);
}

/* Responsive para language toggle */
.language-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 100;
}

@media (max-width: 768px) {
    .language-toggle {
        top: 15px;
        right: 15px;
        gap: 6px;
    }
    
    .lang-btn {
        padding: 6px 12px !important;
        font-size: 12px !important;
        min-width: auto !important;
    }
}

@media (max-width: 480px) {
    .language-toggle {
        top: 10px;
        right: 10px;
        gap: 4px;
    }
    
    .lang-btn {
        padding: 4px 8px !important;
        font-size: 11px !important;
    }
}

/* Ocultar banderas cuando se usa email */
.country-flag.hidden {
    display: none !important;
}

.iti__country-name{
    color: var(--secondary-gray);
}
</style>

<body>
    <div id="recaptcha-container" style="display: none;"></div>
    <div class="container">
        <!-- Language Toggle -->
        <div class="language-toggle">
            <button class="lang-btn" onclick="changeLanguageLocal('es')" id="lang-es">ES</button>
            <button class="lang-btn" onclick="changeLanguageLocal('en')" id="lang-en">EN</button>
        </div>

        <!-- Main Login Container -->
        <div class="login-container">
            <!-- Logo -->
            <div class="logo-container">
                <img src="images/logo.png" alt="MisEstrellas Logo" class="logo">
                <h1 class="brand-name" data-translate="brand_name">MisEstrellas</h1>
            </div>

            <!-- User Type Selector -->
            <div class="user-type-selector">
                <button class="type-btn active" id="client-btn" onclick="selectUserType('client')" data-translate="client">Cliente</button>
                <button class="type-btn" id="admin-btn" onclick="selectUserType('admin')" data-translate="admin">Administrador</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="login-form">
                <!-- Client Login -->
                <div id="client-login" class="login-section active">
                    <div class="input-group">
                        <label data-translate="phone_or_email">Teléfono o Email</label>
                        <input type="tel" id="client-phone" placeholder="+57 300 123 4567" class="input-field">
                        <input type="email" id="client-email" placeholder="email@ejemplo.com" class="input-field" style="display: none;">
                        <button type="button" class="toggle-input" onclick="toggleClientInput()" data-translate="use_email">Usar Email</button>
                    </div>
                </div>

                <!-- Admin Login -->
                <div id="admin-login" class="login-section">
                    <div class="input-group">
                        <label data-translate="email">Email</label>
                        <input type="email" id="admin-email" placeholder="admin@negocio.com" class="input-field">
                    </div>
                    <div class="input-group">
                        <label data-translate="password">Contraseña</label>
                        <input type="password" id="admin-password" placeholder="••••••••" class="input-field">
                    </div>
                </div>

                <!-- Verification Code (for clients) -->
                <div id="verification-section" class="login-section" style="display: none;">
                    <div class="input-group">
                        <label data-translate="verification_code">Código de verificación</label>
                        <input type="text" id="verification-code" placeholder="123456" class="input-field">
                        <p class="verification-info" data-translate="verification_sent">Código enviado a tu teléfono/email</p>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="login-btn" data-translate="continue">Continuar</button>
            </form>

            <!-- Loading Spinner -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p data-translate="loading">Cargando...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <!-- Tu lógica personalizada -->
    <script src="js/translations.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Initialize phone input
        let phoneInput;
        let currentUserType = 'client';
        let isUsingEmail = false;

        let attemptCounts = {
            verification: 0,
            codeRequest: 0,
            lastRequestTime: 0
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializePhoneInput();
            updateTexts();
            setupEventListeners();
        });

        function initializePhoneInput() {
            const phoneField = document.getElementById('client-phone');
            phoneInput = window.intlTelInput(phoneField, {
                initialCountry: 'co',
                preferredCountries: ['co', 'us', 'mx'],
                utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js',
                formatOnDisplay: true,
                nationalMode: false,
                autoPlaceholder: "aggressive"
            });
            
            // Establecer valor por defecto
            phoneField.value = '+57 ';
            
            // Listener para cambios de país
            phoneField.addEventListener('countrychange', function() {
                const countryData = phoneInput.getSelectedCountryData();
                const dialCode = countryData.dialCode;
                phoneField.value = `+${dialCode} `;
                phoneField.focus();
            });
        }

        function selectUserType(type) {
            currentUserType = type;
            
            // Update button states
            document.getElementById('client-btn').classList.toggle('active', type === 'client');
            document.getElementById('admin-btn').classList.toggle('active', type === 'admin');
            
            // Show/hide login sections
            document.getElementById('client-login').classList.toggle('active', type === 'client');
            document.getElementById('admin-login').classList.toggle('active', type === 'admin');
            
            // Hide verification section
            document.getElementById('verification-section').style.display = 'none';
            
            // Update button text
            const loginBtn = document.getElementById('login-btn');
            loginBtn.textContent = type === 'client' ? 'Continuar' : 'Iniciar sesión';
        }

        function toggleClientInput() {
            isUsingEmail = !isUsingEmail;
            const phoneField = document.getElementById('client-phone');
            const emailField = document.getElementById('client-email');
            const toggleBtn = document.querySelector('.toggle-input');
            
            // Obtener el contenedor completo de intl-tel-input
            const phoneContainer = phoneField.closest('.iti');
            const inputGroup = phoneField.closest('.input-group');
            
            // Obtener la bandera específicamente
            const countryFlag = inputGroup.querySelector('.iti__flag-container');
            
            if (isUsingEmail) {
                // Ocultar completamente el input de teléfono y su contenedor
                if (phoneContainer) {
                    phoneContainer.style.display = 'none';
                }
                phoneField.style.display = 'none';
                
                // Ocultar la bandera específicamente
                if (countryFlag) {
                    countryFlag.style.display = 'none';
                    countryFlag.classList.add('hidden');
                }
                
                // Mostrar el campo de email
                emailField.style.display = 'block';
                toggleBtn.textContent = 'Usar Teléfono';
                
                // Limpiar valores
                emailField.value = '';
                phoneField.value = '';
                
            } else {
                // Mostrar el contenedor del teléfono
                if (phoneContainer) {
                    phoneContainer.style.display = 'flex';
                }
                phoneField.style.display = 'block';
                
                // Mostrar la bandera nuevamente
                if (countryFlag) {
                    countryFlag.style.display = 'block';
                    countryFlag.classList.remove('hidden');
                }
                
                // Ocultar el campo de email
                emailField.style.display = 'none';
                toggleBtn.textContent = 'Usar Email';
                
                // Restaurar valor por defecto del teléfono
                phoneField.value = '+57 ';
                emailField.value = '';
                
                // Hacer foco en el campo de teléfono
                setTimeout(() => {
                    phoneField.focus();
                }, 100);
            }
            
            // Limpiar mensajes de error previos
            const existingMessages = document.querySelectorAll('.error-message, .success-message, .temp-message');
            existingMessages.forEach(msg => {
                if (msg.parentNode) {
                    msg.parentNode.removeChild(msg);
                }
            });
            
            // Resetear sección de verificación
            const verificationSection = document.getElementById('verification-section');
            verificationSection.style.display = 'none';
            document.getElementById('verification-code').value = '';
            
            // Resetear botón de login
            const loginBtn = document.getElementById('login-btn');
            loginBtn.textContent = 'Continuar';
            loginBtn.disabled = false;
        }

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                if (currentUserType === 'client') {
                    await handleClientLogin();
                } else {
                    await handleAdminLogin();
                }
            } catch (error) {
                showError(error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function handleClientLogin() {
            const verificationSection = document.getElementById('verification-section');
            
            if (verificationSection.style.display === 'none') {
                const contact = isUsingEmail ? 
                    document.getElementById('client-email').value :
                    phoneInput.getNumber();
                
                if (!contact) {
                    throw new Error('Por favor ingresa tu teléfono o email');
                }
                
                let result;
                
                if (isUsingEmail) {
                    result = await authenticateClientWithEmailLocal(contact);
                    
                    // Para email con enlace, solo mostrar mensaje
                    if (result.isEmailLink) {
                        showMessage(result.message, 'success');
                        
                        // Deshabilitar botón
                        const loginBtn = document.getElementById('login-btn');
                        loginBtn.disabled = true;
                        loginBtn.textContent = 'Enlace enviado - Revisa tu email';
                        
                        return;
                    }
                } else {
                    result = await authenticateClientWithPhoneLocal(contact);
                }
                
                if (result && result.message) {
                    showMessage(result.message, 'success');
                }
                
                // Mostrar verificación solo para teléfono
                if (!isUsingEmail && result.requiresVerification) {
                    verificationSection.style.display = 'block';
                    document.getElementById('login-btn').textContent = 'Verificar';
                }
                
            } else {
                // Verificar código SMS
                const code = document.getElementById('verification-code').value;
                
                if (!code) {
                    throw new Error('Por favor ingresa el código de verificación');
                }
                
                const verificationResult = await verificarCodigoLocal(code);
                
                showMessage('✅ Verificación exitosa. Redirigiendo...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'cliente/dashboard.html';
                }, 1500);
            }
        }

        // 🔥 Función de respaldo para login cliente
        async function loginClienteLocal(contactInfo) {
            try {
                console.log('🔄 Login cliente local iniciado para:', contactInfo);
                
                // Verificar que Firebase esté disponible
                if (!window.auth || !window.db) {
                    throw new Error('Firebase no está inicializado');
                }
                
                if (isEmail(contactInfo)) {
                    // Email-based authentication for clients
                    return await authenticateClientWithEmailLocal(contactInfo);
                } else {
                    // Phone-based authentication
                    return await authenticateClientWithPhoneLocal(contactInfo);
                }
                
            } catch (error) {
                console.error('❌ Error en login cliente local:', error);
                throw error;
            }
        }

        async function authenticateClientWithEmailLocal(email) {
            try {
                console.log('📧 Autenticando con email:', email);
                
                // Verificar límite de solicitudes
                const now = Date.now();
                const timeSinceLastRequest = now - attemptCounts.lastRequestTime;
                
                if (attemptCounts.codeRequest >= 2 && timeSinceLastRequest < 300000) {
                    const remainingTime = Math.ceil((300000 - timeSinceLastRequest) / 60000);
                    throw new Error(`Has alcanzado el límite de solicitudes. Espera ${remainingTime} minutos.`);
                }
                
                if (timeSinceLastRequest >= 300000) {
                    attemptCounts.codeRequest = 0;
                }
                
                if (!window.auth || !window.db) {
                    throw new Error('Firebase no está inicializado completamente.');
                }
                
                try {
                    // 🔥 MÉTODO REAL: Usar Email Link (passwordless)
                    const actionCodeSettings = {
                        url: 'https://santicusi.github.io/index.html?emailSignIn=true',
                        handleCodeInApp: true
                    };
                    
                    // Enviar enlace de acceso al email
                    await window.auth.sendSignInLinkToEmail(email, actionCodeSettings);
                    
                    // Guardar email para completar el proceso
                    localStorage.setItem('emailForSignIn', email);
                    localStorage.setItem('pendingEmailSignIn', 'true');
                    
                    attemptCounts.codeRequest++;
                    attemptCounts.lastRequestTime = now;
                    attemptCounts.verification = 0;
                    
                    return {
                        success: true,
                        message: `Enlace de acceso enviado a ${email}. Revisa tu bandeja de entrada y haz clic en el enlace.`,
                        requiresVerification: true,
                        isEmailLink: true
                    };
                    
                } catch (emailError) {
                    console.error('❌ Error enviando enlace de email:', emailError);
                    
                    if (emailError.code === 'auth/invalid-email') {
                        throw new Error('Dirección de email inválida');
                    } else if (emailError.code === 'auth/operation-not-allowed') {
                        throw new Error('Autenticación por email no está habilitada. Contacta al administrador.');
                    } else if (emailError.code === 'auth/too-many-requests') {
                        throw new Error('Demasiadas solicitudes. Espera unos minutos.');
                    } else {
                        throw new Error('Error enviando enlace de acceso: ' + emailError.message);
                    }
                }
                
            } catch (error) {
                console.error('❌ Error en autenticación por email:', error);
                throw error;
            }
        }

        // 🔥 Función mejorada para manejo de SMS con modo de prueba
        async function authenticateClientWithPhoneLocal(phoneNumber) {
            try {
                console.log('📱 Autenticando con teléfono:', phoneNumber);
                
                // Verificar límite de solicitudes
                const now = Date.now();
                const timeSinceLastRequest = now - attemptCounts.lastRequestTime;
                
                if (attemptCounts.codeRequest >= 2 && timeSinceLastRequest < 300000) {
                    const remainingTime = Math.ceil((300000 - timeSinceLastRequest) / 60000);
                    throw new Error(`Has alcanzado el límite de solicitudes. Espera ${remainingTime} minutos.`);
                }
                
                if (timeSinceLastRequest >= 300000) {
                    attemptCounts.codeRequest = 0;
                }
                
                const formattedPhone = formatPhoneNumber(phoneNumber);
                console.log('📱 Teléfono formateado:', formattedPhone);
                
                if (!window.auth) {
                    throw new Error('Firebase Auth no está inicializado');
                }
                
                try {
                    console.log('📤 Enviando SMS REAL a:', formattedPhone);
                    
                    // 🔥 LIMPIAR RECAPTCHA COMPLETAMENTE ANTES DE CREAR UNO NUEVO
                    if (window.recaptchaVerifier) {
                        try {
                            await window.recaptchaVerifier.clear();
                            window.recaptchaVerifier = null;
                        } catch (e) {
                            console.log('Limpiando reCAPTCHA anterior');
                        }
                    }
                    
                    // Limpiar contenedor anterior
                    let recaptchaContainer = document.getElementById('recaptcha-container');
                    if (recaptchaContainer) {
                        recaptchaContainer.remove();
                    }
                    
                    // Crear nuevo contenedor limpio
                    recaptchaContainer = document.createElement('div');
                    recaptchaContainer.id = 'recaptcha-container';
                    recaptchaContainer.style.display = 'none';
                    document.body.appendChild(recaptchaContainer);
                    
                    // Crear nuevo reCAPTCHA
                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'invisible',
                        'callback': function(response) {
                            console.log('✅ reCAPTCHA verificado');
                        },
                        'expired-callback': function() {
                            console.log('⚠️ reCAPTCHA expirado');
                        }
                    });
                    
                    // Enviar SMS REAL
                    window.confirmationResult = await window.auth.signInWithPhoneNumber(
                        formattedPhone, 
                        window.recaptchaVerifier
                    );
                    
                    attemptCounts.codeRequest++;
                    attemptCounts.lastRequestTime = now;
                    attemptCounts.verification = 0;
                    
                    console.log('✅ SMS REAL enviado a:', formattedPhone);
                    
                    return {
                        success: true,
                        message: `Código de verificación enviado a ${formattedPhone}. Expira en 5 minutos.`,
                        requiresVerification: true
                    };
                    
                } catch (smsError) {
                    console.error('❌ Error enviando SMS:', smsError);
                    
                    // Limpiar en caso de error
                    if (window.recaptchaVerifier) {
                        try {
                            await window.recaptchaVerifier.clear();
                            window.recaptchaVerifier = null;
                        } catch (e) {}
                    }
                    
                    if (smsError.code === 'auth/too-many-requests') {
                        throw new Error('Demasiadas solicitudes de SMS. Espera 1 hora.');
                    } else if (smsError.code === 'auth/invalid-phone-number') {
                        throw new Error('Número de teléfono inválido. Verifica el formato (+57...).');
                    } else if (smsError.code === 'auth/quota-exceeded') {
                        throw new Error('Cuota de SMS excedida.');
                    } else {
                        throw new Error('Error enviando SMS: ' + smsError.message);
                    }
                }
                
            } catch (error) {
                console.error('❌ Error en autenticación por teléfono:', error);
                throw error;
            }
        }

        

        // 🔥 Función mejorada para verificar código
        async function verificarCodigoLocal(verificationCode) {
            try {
                console.log('🔍 Verificando código:', verificationCode);
                
                if (!verificationCode || verificationCode.length !== 6) {
                    throw new Error('El código debe tener 6 dígitos');
                }
                
                // Verificar límite de intentos
                if (attemptCounts.verification >= 3) {
                    throw new Error('Has excedido el número máximo de intentos (3). Solicita un nuevo código.');
                }
                
                if (!window.confirmationResult) {
                    throw new Error('No hay un proceso de verificación activo. Solicita un nuevo código.');
                }
                
                try {
                    // Verificar código con Firebase
                    const result = await window.confirmationResult.confirm(verificationCode);
                    console.log('✅ Código verificado exitosamente');
                    
                    // Reset contadores en caso de éxito
                    attemptCounts.verification = 0;
                    attemptCounts.codeRequest = 0;
                    
                    // Crear o actualizar perfil del usuario
                    if (result && result.user) {
                        await createOrUpdateClientProfileLocal(result.user);
                        console.log('✅ Perfil de usuario creado/actualizado');
                        
                        // Configurar persistencia de sesión
                        await window.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                        console.log('✅ Persistencia de sesión configurada');
                    }
                    
                    return {
                        success: true,
                        user: result.user
                    };
                    
                } catch (verificationError) {
                    // Incrementar contador de intentos fallidos
                    attemptCounts.verification++;
                    const remainingAttempts = 3 - attemptCounts.verification;
                    
                    console.error('❌ Error verificando código:', verificationError);
                    
                    if (verificationError.code === 'auth/invalid-verification-code') {
                        if (remainingAttempts > 0) {
                            throw new Error(`Código incorrecto. Te quedan ${remainingAttempts} intentos.`);
                        } else {
                            throw new Error('Código incorrecto. Has agotado tus intentos. Solicita un nuevo código.');
                        }
                    } else if (verificationError.code === 'auth/code-expired') {
                        throw new Error('El código ha expirado. Solicita uno nuevo.');
                    } else {
                        throw new Error('Error verificando código. Intenta nuevamente.');
                    }
                }
                
            } catch (error) {
                console.error('❌ Error en verificación:', error);
                throw error;
            }
        }

        async function verificarEnlaceEmail() {
            try {
                if (window.auth.isSignInWithEmailLink(window.location.href)) {
                    console.log('🔗 Procesando enlace de email...');
                    
                    const email = localStorage.getItem('emailForSignIn');
                    if (!email) {
                        throw new Error('No se encontró el email asociado. Solicita un nuevo enlace.');
                    }
                    
                    // Completar autenticación
                    const result = await window.auth.signInWithEmailLink(email, window.location.href);
                    
                    // Limpiar almacenamiento
                    localStorage.removeItem('emailForSignIn');
                    localStorage.removeItem('pendingEmailSignIn');
                    
                    // Crear perfil
                    await createOrUpdateClientProfileLocal(result.user);
                    
                    // Configurar persistencia
                    await window.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    
                    console.log('✅ Autenticación por email completada');
                    
                    // Redirigir
                    window.location.href = 'cliente/dashboard.html';
                    
                    return { success: true, user: result.user };
                }
                
                return null;
                
            } catch (error) {
                console.error('❌ Error verificando enlace:', error);
                localStorage.removeItem('emailForSignIn');
                localStorage.removeItem('pendingEmailSignIn');
                throw new Error('Enlace inválido o expirado. Solicita uno nuevo.');
            }
        }

        // 🔥 Función mejorada para crear/actualizar perfil de cliente
        async function createOrUpdateClientProfileLocal(user) {
            try {
                console.log('👤 Creando/actualizando perfil para:', user.uid);
                
                if (!window.db) {
                    console.log('⚠️ Firestore no disponible');
                    return;
                }
                
                const userRef = window.db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    // Actualizar perfil existente
                    await userRef.update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        emailVerified: user.emailVerified,
                        phoneVerified: !!user.phoneNumber,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('✅ Perfil actualizado');
                } else {
                    // Crear nuevo perfil de cliente
                    const profileData = {
                        name: user.displayName || user.phoneNumber || user.email || 'Cliente',
                        email: user.email || null,
                        phoneNumber: user.phoneNumber || null,
                        phoneVerified: !!user.phoneNumber,
                        emailVerified: user.emailVerified || false,
                        userType: 'client',
                        totalPoints: 0,
                        totalVisits: 0,
                        totalRedemptions: 0,
                        joinedBusinesses: [],
                        isActive: true,
                        displayName: user.displayName || user.phoneNumber || user.email || 'Cliente',
                        preferences: {
                            language: localStorage.getItem('lang') || 'es',
                            notifications: true,
                            theme: 'light'
                        },
                        registrationSource: user.phoneNumber ? 'phone' : 'email',
                        analytics: {
                            averagePointsPerVisit: 0
                        },
                        avatar: user.photoURL || '',
                        location: {
                            city: 'No especificada',
                            coordinates: {}
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await userRef.set(profileData);
                    console.log('✅ Perfil creado');
                }
                
            } catch (error) {
                console.error('❌ Error managing client profile:', error);
                // No lanzar error para no bloquear el flujo
                console.log('⚠️ Continuando sin crear perfil en Firestore');
            }
        }

        // 🔥 FUNCIÓN PARA INICIALIZAR VERIFICACIÓN DE EMAIL AL CARGAR LA PÁGINA (NUEVA)
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar enlace de email al cargar
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('emailSignIn') === 'true' || 
                (window.auth && window.auth.isSignInWithEmailLink && window.auth.isSignInWithEmailLink(window.location.href))) {
                try {
                    await verificarEnlaceEmail();
                } catch (error) {
                    console.error('Error procesando enlace:', error);
                    showMessage(error.message, 'error');
                }
            }
            
            // Resto de inicialización
            initializePhoneInput();
            updateTexts();
            setupEventListeners();

            document.getElementById('client-email').style.display = 'none';
            document.getElementById('client-phone').style.display = 'block';
        });

        function formatPhoneNumber(phoneNumber) {
            // Remove all non-digit characters
            let cleaned = phoneNumber.replace(/\D/g, '');
            
            // Add country code if not present (default to Colombia +57)
            if (!cleaned.startsWith('57') && cleaned.length === 10) {
                cleaned = '57' + cleaned;
            }
            
            // Add '+' prefix
            return '+' + cleaned;
        }

        function isEmail(input) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(input);
        }

        function generateTempPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            
            for (let i = 0; i < 16; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return password;
        }

        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (!email || !password) {
                throw new Error('Email y contraseña son requeridos');
            }

            console.log('🔍 Verificando window.loginAdmin:', typeof window.loginAdmin);

            // Verificar si la función está disponible
            if (typeof window.loginAdmin !== 'function') {
                console.log('⏳ Esperando a que loginAdmin esté disponible...');
                
                for (let i = 0; i < 50; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (typeof window.loginAdmin === 'function') {
                        console.log('✅ loginAdmin ahora está disponible');
                        break;
                    }
                }
                
                if (typeof window.loginAdmin !== 'function') {
                    console.log('⚠️ window.loginAdmin no disponible, usando función local');
                    return await loginAdminLocal(email, password);
                }
            }

            // Usar la función global
            const result = await window.loginAdmin(email, password);
            console.log('✅ Login exitoso:', result);
            window.location.href = 'admin/dashboard.html';
        }

        // Función de respaldo para admin (la que ya tenías)
        async function loginAdminLocal(email, password) {
            try {
                console.log('🔄 Login local iniciado para:', email);
                
                if (!window.auth || !window.db) {
                    throw new Error('Firebase no está inicializado');
                }
                
                const userCredential = await window.auth.signInWithEmailAndPassword(email, password);
                console.log('✅ Autenticación Firebase exitosa, UID:', userCredential.user.uid);
                
                // 🔥 AQUÍ AGREGAMOS MÁS DEBUG
                console.log('📄 Obteniendo documento de Firestore...');
                const userDoc = await window.db.collection('users').doc(userCredential.user.uid).get();
                console.log('📄 Documento obtenido:', userDoc.exists);
                
                if (!userDoc.exists) {
                    console.log('❌ El documento no existe en Firestore para UID:', userCredential.user.uid);
                    await window.auth.signOut();
                    throw new Error('Usuario no encontrado en la base de datos');
                }

                console.log('📊 Datos del documento:', userDoc.data());
                const userData = userDoc.data();
                console.log('👤 userData completo:', JSON.stringify(userData, null, 2));
                
                const userType = userData.userType;
                console.log('🏷️ userType raw:', userType, 'tipo:', typeof userType);
                
                const cleanUserType = userType.toString().replace(/['"]/g, '').trim();
                console.log('🧹 userType limpio:', cleanUserType);
                
                if (!cleanUserType || cleanUserType !== 'admin') {
                    console.log('🚫 No es admin. Valor esperado: "admin", valor encontrado:', cleanUserType);
                    console.log('🚫 Comparación stricta:', cleanUserType === 'admin');
                    await window.auth.signOut();
                    throw new Error(`Acceso no autorizado. UserType encontrado: "${cleanUserType}"`);
                }

                console.log('🎉 Admin autenticado correctamente');
                console.log('🔄 Redirigiendo a dashboard...');
                window.location.href = 'admin/dashboard.html';
                
                return {
                    success: true,
                    user: userCredential.user,
                    profile: userData
                };
                
            } catch (error) {
                console.error('❌ Error completo en login local:', error);
                console.error('❌ Error stack:', error.stack);
                console.error('❌ Error message:', error.message);
                throw error;
            }
        }

        function showError(message) {
            alert(message);
        }

        function showMessage(message, type = 'info') {
            // Remover mensajes anteriores
            const existingMessages = document.querySelectorAll('.temp-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'temp-message';
            messageDiv.style.cssText = `
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
                color: white;
                padding: 12px;
                border-radius: 8px;
                margin: 10px 0;
                text-align: center;
                font-size: 14px;
            `;
            messageDiv.textContent = message;
            
            const loginBtn = document.getElementById('login-btn');
            loginBtn.parentNode.insertBefore(messageDiv, loginBtn);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // 🔥 REEMPLAZAR POR ESTA FUNCIÓN MEJORADA:
        function updateTexts() {
            console.log('🌐 Actualizando textos...');
            
            // Verificar si translations.js está cargado
            if (typeof window.t !== 'function') {
                console.warn('⚠️ Función de traducción no disponible, usando fallback');
                updateTextsWithFallback();
                return;
            }
            
            try {
                const currentLang = getLanguageLocal();
                console.log('🌍 Idioma actual:', currentLang);
                
                // Update all elements with data-translate attribute
                const elements = document.querySelectorAll('[data-translate]');
                console.log('🔄 Actualizando', elements.length, 'elementos');
                
                elements.forEach(element => {
                    const key = element.getAttribute('data-translate');
                    const translation = window.t(key);
                    
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'email' || element.type === 'tel')) {
                        // Update placeholder for input elements
                        element.placeholder = translation;
                    } else if (element.tagName === 'BUTTON' || element.tagName === 'SPAN' || element.tagName === 'P' || element.tagName === 'H1' || element.tagName === 'H2' || element.tagName === 'LABEL') {
                        // Update text content for other elements
                        element.textContent = translation;
                    }
                    
                    console.log('✅ Traducido:', key, '→', translation);
                });
                
                // Update language buttons
                updateLanguageButtonsLocal();
                
                console.log('✅ Traducciones aplicadas exitosamente');
                
            } catch (error) {
                console.error('❌ Error aplicando traducciones:', error);
                updateTextsWithFallback();
            }
        }

        // 🔥 FUNCIÓN PARA OBTENER IDIOMA LOCAL (sin conflictos)
        function getLanguageLocal() {
            try {
                // Si existe la función global, usarla SOLO si no estamos en un bucle
                if (typeof window.getCurrentLanguage === 'function' && window.getCurrentLanguage !== getLanguageLocal) {
                    return window.getCurrentLanguage();
                } else {
                    // Usar localStorage directamente
                    return localStorage.getItem('lang') || 'es';
                }
            } catch (error) {
                console.warn('⚠️ Error obteniendo idioma:', error);
                return 'es';
            }
        }

        // 🔥 FUNCIÓN PARA ACTUALIZAR BOTONES DE IDIOMA LOCAL
        function updateLanguageButtonsLocal() {
            try {
                const currentLang = getLanguageLocal();
                
                // Update language toggle buttons
                const langButtons = document.querySelectorAll('.lang-btn');
                langButtons.forEach(btn => {
                    const btnLang = btn.id.replace('lang-', '');
                    btn.classList.toggle('active', btnLang === currentLang);
                });
                
                console.log('🔄 Botones de idioma actualizados para:', currentLang);
            } catch (error) {
                console.error('❌ Error actualizando botones de idioma:', error);
            }
        }

        // 🔥 FUNCIÓN PARA CAMBIAR IDIOMA (evita conflictos)
        function changeLanguageLocal(lang) {
            try {
                console.log('🌍 Cambiando idioma a:', lang);
                
                // Usar la función global si está disponible
                if (typeof window.changeLanguage === 'function') {
                    window.changeLanguage(lang);
                } else {
                    // Fallback: cambiar manualmente
                    localStorage.setItem('lang', lang);
                    updateLanguageButtonsLocal();
                    updateTexts();
                }
                
                console.log('✅ Idioma cambiado a:', lang);
            } catch (error) {
                console.error('❌ Error cambiando idioma:', error);
                // Fallback básico
                localStorage.setItem('lang', lang);
                updateLanguageButtonsLocal();
                updateTexts();
            }
        }

        // 🔥 FUNCIÓN DE TRADUCCIÓN LOCAL CON FALLBACK
        function tLocal(key) {
            try {
                if (typeof window.t === 'function') {
                    return window.t(key);
                } else {
                    return getBasicTranslation(key);
                }
            } catch (error) {
                console.warn('⚠️ Error en traducción para:', key);
                return getBasicTranslation(key);
            }
        }

        // 🔥 TRADUCCIONES BÁSICAS DE RESPALDO
        function getBasicTranslation(key) {
            const lang = getLanguageLocal();
            
            const basicTranslations = {
                es: {
                    'brand_name': 'MisEstrellas',
                    'client': 'Cliente', 
                    'admin': 'Administrador',
                    'phone_or_email': 'Teléfono o Email',
                    'email': 'Email',
                    'password': 'Contraseña',
                    'verification_code': 'Código de verificación',
                    'verification_sent': 'Código enviado a tu teléfono/email',
                    'use_email': 'Usar Email',
                    'continue': 'Continuar',
                    'loading': 'Cargando...',
                    'login': 'Iniciar sesión'
                },
                en: {
                    'brand_name': 'MyStars',
                    'client': 'Client', 
                    'admin': 'Administrator',
                    'phone_or_email': 'Phone or Email',
                    'email': 'Email',
                    'password': 'Password',
                    'verification_code': 'Verification code',
                    'verification_sent': 'Code sent to your phone/email',
                    'use_email': 'Use Email',
                    'continue': 'Continue',
                    'loading': 'Loading...',
                    'login': 'Sign in'
                }
            };
            
            return basicTranslations[lang]?.[key] || basicTranslations['es']?.[key] || key;
        }

        // 🔥 FUNCIÓN DE ACTUALIZACIÓN CON FALLBACK BÁSICO
        function updateTextsWithFallback() {
            console.log('🔄 Usando traducciones de respaldo...');
            
            try {
                const elements = document.querySelectorAll('[data-translate]');
                
                elements.forEach(element => {
                    const key = element.getAttribute('data-translate');
                    const translation = getBasicTranslation(key);
                    
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'email' || element.type === 'tel')) {
                        element.placeholder = translation;
                    } else {
                        element.textContent = translation;
                    }
                });
                
                updateLanguageButtonsLocal();
                console.log('✅ Traducciones básicas aplicadas');
                
            } catch (error) {
                console.error('❌ Error en traducciones de respaldo:', error);
            }
        }

        // 🔥 INICIALIZACIÓN SEGURA
        function initializeTranslations() {
            try {
                // Establecer idioma por defecto si no existe
                if (!localStorage.getItem('lang')) {
                    const browserLang = navigator.language || navigator.userLanguage;
                    const lang = browserLang.startsWith('en') ? 'en' : 'es';
                    localStorage.setItem('lang', lang);
                }
                
                // Actualizar textos y botones
                updateLanguageButtonsLocal();
                updateTexts();
                
                console.log('✅ Sistema de traducciones inicializado');
            } catch (error) {
                console.error('❌ Error inicializando traducciones:', error);
            }
        }
    </script>
</body>
</html>