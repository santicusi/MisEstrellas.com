<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas - Perfil</title>
    <!-- Firebase v8 para compatibilidad -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>


    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
</head>

<style>
    :root {
    /* Variables principales que faltan */
    --bg-black: #0F0F0F;
    --text-white: #FFFFFF;
    --success-green: #4CAF50;
    --error-red: #F44336;
    --warning-yellow: #FFC107;
    
    /* Colores mejorados */
    --primary-orange: #FF8C42;
    --hover-orange: #FF7A2B;
    --accent-orange: #FFA366;
    --dark-orange: #E67A35;
    
    /* Tonos c√°lidos en lugar de grises */
    --warm-gray: #2A2A2A;
    --light-warm: #363636;
    --card-warm: #1F1F1F;
    --border-warm: #404040;
    --secondary-gray: #AAA;
    
    /* Gradientes */
    --gradient-card: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
    --gradient-orange: linear-gradient(135deg, #FF8C42 0%, #FFA366 100%);
    --gradient-dark: linear-gradient(135deg, #0F0F0F 0%, #1F1F1F 100%);
    
    /* Actualizar variables existentes */
    --card-bg: var(--gradient-card);
    --border-color: var(--border-warm);
    --input-bg: var(--warm-gray);
    --shadow-dark: rgba(0, 0, 0, 0.3);
    --shadow-orange: rgba(255, 140, 66, 0.2);
}

.qr-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    text-align: center;
    color: var(--error-red);
}

.qr-error i {
    font-size: 2rem;
    margin-bottom: 10px;
}

.retry-btn {
    background: var(--primary-orange);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
}

.retry-btn:hover {
    background: var(--hover-orange);
}

/* Canvas QR personalizado */
.qr-canvas {
    border: 2px solid var(--primary-orange);
    border-radius: 8px;
    background: white;
    padding: 10px;
}
</style>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 data-translate="profile">Perfil</h1>
                <div class="language-toggle">
                    <button class="lang-btn" onclick="changeLanguage('es')" id="lang-es">ES</button>
                    <button class="lang-btn" onclick="changeLanguage('en')" id="lang-en">EN</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar">
                    <img id="profile-image" src="../images/avatar.png" alt="Profile">
                    <button class="edit-avatar-btn" onclick="changeProfileImage()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="profile-info">
                    <h2 id="profile-name" class="profile-name">Usuario</h2>
                    <p id="profile-contact" class="profile-contact">+57 300 123 4567</p>
                    <p id="profile-member-since" class="profile-member-since" data-translate="member_since">Miembro desde: Enero 2024</p>
                </div>
            </div>

            <!-- Profile Form -->
            <div class="profile-form">
                <div class="form-section">
                    <h3 data-translate="personal_info">Informaci√≥n Personal</h3>
                    
                    <div class="input-group">
                        <label data-translate="name">Nombre</label>
                        <input type="text" id="user-name" class="input-field" placeholder="Tu nombre">
                        <button class="edit-btn" onclick="enableEdit('user-name')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <label data-translate="phone">Tel√©fono</label>
                        <input type="tel" id="user-phone" class="input-field" placeholder="+57 300 123 4567" readonly>
                    </div>
                    
                    <div class="input-group">
                        <label data-translate="email">Email</label>
                        <input type="email" id="user-email" class="input-field" placeholder="email@ejemplo.com" readonly>
                    </div>
                </div>

                <!-- Personal QR Code -->
                <div class="form-section">
                    <h3 data-translate="personal_qr">Tu C√≥digo QR Personal</h3>
                    <div class="qr-section">
                        <div class="qr-container">
                            <canvas id="personal-qr" class="qr-canvas" width="200" height="200"></canvas>
                            <div class="qr-loading" id="qr-loading" style="display: none;">
                                <div class="spinner"></div>
                                <p data-translate="generating_qr">Generando QR...</p>
                            </div>
                        </div>
                        <div class="qr-info">
                            <p class="qr-code-text" id="qr-code-text">ABC123XYZ</p>
                            <p class="qr-description" data-translate="qr_description">Los negocios pueden escanear este c√≥digo para pagar con puntos</p>
                            <button class="btn-secondary" onclick="refreshQR()" data-translate="refresh_qr">Actualizar QR</button>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="form-section">
                    <div class="profile-actions">
                        <button class="btn-primary" onclick="saveProfile()" data-translate="save_changes">Guardar Cambios</button>
                        <button class="btn-secondary" onclick="logout()" data-translate="logout">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span data-translate="dashboard">Dashboard</span>
            </a>
            <a href="escanear-qr.html" class="nav-item">
                <i class="fas fa-qrcode"></i>
                <span data-translate="scan_qr">Escanear QR</span>
            </a>
            <a href="mapa.html" class="nav-item">
                <i class="fas fa-map"></i>
                <span data-translate="map">Mapa</span>
            </a>
            <a href="perfil.html" class="nav-item active">
                <i class="fas fa-user"></i>
                <span data-translate="profile">Perfil</span>
            </a>
        </nav>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal" id="image-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="change_photo">Cambiar Foto</h2>
                <button class="close-btn" onclick="closeImageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-options">
                    <button class="option-btn" onclick="selectImageFromGallery()">
                        <i class="fas fa-image"></i>
                        <span data-translate="select_from_gallery">Seleccionar de la galer√≠a</span>
                    </button>
                    <button class="option-btn" onclick="takePhoto()">
                        <i class="fas fa-camera"></i>
                        <span data-translate="take_photo">Tomar foto</span>
                    </button>
                </div>
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/translations.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        // REEMPLAZA toda la secci√≥n <script> en tu perfil.html con este c√≥digo corregido:

        let currentUser = null;
        let personalQRCode = null;
        let isEditing = false;

        // CORREGIDO: ID consistente del usuario simulado
        const SIMULATED_USER_ID = 'XMfYVWEwk5a8bDCuK6dtfJ1c0Zj2';

        document.addEventListener("DOMContentLoaded", function () {
            console.log('üöÄ Inicializando perfil...');
            
            // Esperar a que Firebase est√© listo
            if (window.auth && window.db) {
                initializeProfile();
            } else {
                window.addEventListener('firebaseReady', initializeProfile);
            }
        });

        function initializeProfile() {
            console.log('üî• Firebase listo, configurando perfil...');
            
            // Verificar si hay usuario simulado primero
            const simulatedUser = localStorage.getItem('simulatedUser');
            if (simulatedUser) {
                console.log('üß™ Usuario simulado encontrado');
                try {
                    const user = JSON.parse(simulatedUser);
                    window.simulatedUser = user;
                    currentUser = user;
                    
                    console.log('‚úÖ Usuario simulado cargado:', user.uid);
                    loadUserProfile();
                    loadUserStatistics();
                    
                    // Esperar un poco antes de generar QR
                    setTimeout(() => {
                        generatePersonalQR();
                    }, 500);
                    
                    return;
                } catch (error) {
                    console.error('‚ùå Error cargando usuario simulado:', error);
                }
            }
            
            // Auth listener normal para usuarios reales
            window.auth.onAuthStateChanged(function(user) {
                if (user) {
                    const uid = user.uid;
                    console.log("‚úÖ Usuario autenticado. UID:", uid);
                    currentUser = user;
                    loadUserProfile();
                    loadUserStatistics();
                    
                    setTimeout(() => {
                        generatePersonalQR();
                    }, 500);
                } else {
                    console.warn("‚ùå No hay usuario autenticado. Redirigiendo...");
                    window.location.href = "../index.html";
                }
            });
        }

        // CORREGIDO: Funci√≥n para cargar perfil real desde Firebase
        async function loadUserProfile() {
            try {
                console.log('üìä Cargando perfil del usuario...');
                
                let userProfile;
                let userId = currentUser.uid;
                
                // Si es usuario simulado, usar ID fijo
                if (window.simulatedUser) {
                    userId = SIMULATED_USER_ID;
                    console.log('üß™ Usando ID de usuario simulado:', userId);
                }
                
                // Obtener datos reales desde Firestore
                if (window.db) {
                    console.log('üîç Buscando usuario en Firebase:', userId);
                    const userDoc = await window.db.collection('users').doc(userId).get();
                    
                    if (userDoc.exists) {
                        userProfile = userDoc.data();
                        console.log('‚úÖ Perfil encontrado en Firebase:', userProfile);
                    } else {
                        console.log('‚ùå Usuario no encontrado en Firebase, creando perfil b√°sico...');
                        
                        // Crear perfil b√°sico si no existe
                        const basicProfile = {
                            name: window.simulatedUser ? 'Usuario Demo' : (currentUser.displayName || 'Usuario'),
                            email: window.simulatedUser ? 'demo@example.com' : currentUser.email,
                            phoneNumber: window.simulatedUser ? '+57 300 123 4567' : (currentUser.phoneNumber || ''),
                            totalPoints: 0,
                            totalEarned: 0,
                            totalVisits: 0,
                            joinedBusinesses: [],
                            userType: 'client',
                            isActive: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await window.db.collection('users').doc(userId).set(basicProfile);
                        userProfile = basicProfile;
                        console.log('‚úÖ Perfil b√°sico creado');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Firestore no disponible, usando datos locales');
                    userProfile = {
                        name: 'Usuario Demo',
                        email: 'demo@example.com',
                        phoneNumber: '+57 300 123 4567'
                    };
                }
                
                // Actualizar la interfaz con los datos cargados
                if (userProfile) {
                    updateProfileUI(userProfile);
                }
                
            } catch (error) {
                console.error('‚ùå Error loading user profile:', error);
                showError('Error cargando perfil: ' + error.message);
                
                // Mostrar datos por defecto en caso de error
                updateProfileUI({
                    name: 'Usuario',
                    email: 'email@ejemplo.com',
                    phoneNumber: '+57 300 123 4567'
                });
            }
        }

        // NUEVA: Funci√≥n para actualizar la UI con los datos del perfil
        function updateProfileUI(userProfile) {
            console.log('üé® Actualizando UI con perfil:', userProfile);
            
            // Actualizar elementos de la interfaz
            const profileName = document.getElementById('profile-name');
            const profileContact = document.getElementById('profile-contact');
            const userName = document.getElementById('user-name');
            const userPhone = document.getElementById('user-phone');
            const userEmail = document.getElementById('user-email');
            const profileMemberSince = document.getElementById('profile-member-since');
            
            if (profileName) {
                profileName.textContent = userProfile.name || userProfile.displayName || 'Usuario';
            }
            
            if (profileContact) {
                profileContact.textContent = userProfile.phoneNumber || userProfile.email || '';
            }
            
            if (userName) {
                userName.value = userProfile.name || userProfile.displayName || '';
            }
            
            if (userPhone) {
                userPhone.value = userProfile.phoneNumber || '';
            }
            
            if (userEmail) {
                userEmail.value = userProfile.email || '';
            }
            
            // Actualizar imagen de perfil si existe
            if (userProfile.avatar || userProfile.photoURL) {
                const profileImage = document.getElementById('profile-image');
                if (profileImage) {
                    profileImage.src = userProfile.avatar || userProfile.photoURL;
                }
            }
            
            // Actualizar fecha de creaci√≥n
            if (profileMemberSince && userProfile.createdAt) {
                try {
                    const date = userProfile.createdAt.toDate ? userProfile.createdAt.toDate() : new Date(userProfile.createdAt);
                    const memberSince = date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long'
                    });
                    profileMemberSince.textContent = `Miembro desde: ${memberSince}`;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error procesando fecha de creaci√≥n:', error);
                    profileMemberSince.textContent = 'Miembro desde: 2024';
                }
            }
            
            console.log('‚úÖ UI actualizada correctamente');
        }

        // CORREGIDO: Funci√≥n para cargar estad√≠sticas reales
        async function loadUserStatistics() {
            try {
                console.log('üìà Cargando estad√≠sticas del usuario...');
                
                let userId = currentUser.uid;
                if (window.simulatedUser) {
                    userId = SIMULATED_USER_ID;
                }
                
                let stats = {
                    totalStars: 0,
                    visitedBusinesses: 0,
                    thisMonthStars: 0
                };
                
                if (window.db) {
                    // Obtener datos del usuario desde Firebase
                    const userDoc = await window.db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        stats.totalStars = userData.totalPoints || userData.totalEarned || 0;
                        stats.visitedBusinesses = userData.joinedBusinesses ? userData.joinedBusinesses.length : 0;
                    }
                    
                    // Calcular puntos del mes actual
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    const monthlyTransactions = await window.db.collection('transactions')
                        .where('userId', '==', userId)
                        .where('type', '==', 'earned')
                        .where('createdAt', '>=', startOfMonth)
                        .get();
                    
                    stats.thisMonthStars = 0;
                    monthlyTransactions.forEach(doc => {
                        const transaction = doc.data();
                        stats.thisMonthStars += transaction.points || 0;
                    });
                }
                
                // Actualizar estad√≠sticas en la UI si existen los elementos
                updateStatsUI(stats);
                
            } catch (error) {
                console.error('‚ùå Error loading statistics:', error);
                // Mostrar estad√≠sticas por defecto
                updateStatsUI({
                    totalStars: 0,
                    visitedBusinesses: 0,
                    thisMonthStars: 0
                });
            }
        }

        // NUEVA: Funci√≥n para actualizar estad√≠sticas en la UI
        function updateStatsUI(stats) {
            const totalStarsEl = document.getElementById('total-stars');
            const visitedBusinessesEl = document.getElementById('visited-businesses');
            const thisMonthStarsEl = document.getElementById('this-month-stars');
            
            if (totalStarsEl) {
                totalStarsEl.textContent = stats.totalStars || '0';
            }
            
            if (visitedBusinessesEl) {
                visitedBusinessesEl.textContent = stats.visitedBusinesses || '0';
            }
            
            if (thisMonthStarsEl) {
                thisMonthStarsEl.textContent = stats.thisMonthStars || '0';
            }
            
            console.log('üìä Estad√≠sticas actualizadas:', stats);
        }

        // Funci√≥n para generar QR FIJO permanente (mantenida igual)
        async function generarQRPersonal(userId) {
            try {
                console.log('üîê Generando/obteniendo QR personal FIJO para usuario:', userId);
                
                const realUserId = window.simulatedUser ? SIMULATED_USER_ID : userId;
                
                // Intentar obtener desde Firebase primero
                try {
                    const userDoc = await window.db.collection('users').doc(realUserId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // Si ya tiene QR guardado en Firebase, usarlo
                        if (userData.personalQR && userData.personalQR.code) {
                            console.log('‚úÖ QR encontrado en Firebase:', userData.personalQR);
                            return userData.personalQR;
                        }
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è No se pudo acceder a Firebase, usando localStorage');
                }
                
                // Si no est√° en Firebase, verificar localStorage
                let savedQRData = localStorage.getItem(`userQR_${realUserId}`);
                if (savedQRData) {
                    console.log('‚úÖ QR encontrado en localStorage');
                    const qrData = JSON.parse(savedQRData);
                    
                    // Intentar guardar en Firebase para futuras consultas
                    try {
                        await window.db.collection('users').doc(realUserId).update({
                            personalQR: qrData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('‚úÖ QR guardado en Firebase');
                    } catch (error) {
                        console.log('‚ö†Ô∏è No se pudo guardar en Firebase');
                    }
                    
                    return qrData;
                }
                
                // Generar nuevo QR FIJO
                const fixedCode = generateFixedUserCode(realUserId);
                const code = `USER:${realUserId}:${fixedCode}`;
                const displayCode = `${realUserId.substring(0, 4).toUpperCase()}-${fixedCode}`;
                
                const qrData = {
                    code: code,
                    displayCode: displayCode,
                    userId: realUserId,
                    fixedCode: fixedCode,
                    createdAt: new Date().toISOString()
                };
                
                // Guardar en localStorage
                localStorage.setItem(`userQR_${realUserId}`, JSON.stringify(qrData));
                
                // Intentar guardar en Firebase
                try {
                    await window.db.collection('users').doc(realUserId).update({
                        personalQR: qrData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Nuevo QR guardado en Firebase');
                } catch (error) {
                    console.log('‚ö†Ô∏è QR guardado solo en localStorage');
                }
                
                console.log('‚úÖ Nuevo QR FIJO generado:', qrData);
                return qrData;
                
            } catch (error) {
                console.error('‚ùå Error generando QR personal:', error);
                throw error;
            }
        }

        // CORREGIDO: Funci√≥n para actualizar perfil con ID consistente
        async function actualizarPerfil(userId, profileData) {
            console.log('üíæ Updating profile for:', userId, profileData);
            
            try {
                const realUserId = window.simulatedUser ? SIMULATED_USER_ID : userId;
                
                // Actualizar en Firebase si est√° disponible
                if (window.db) {
                    await window.db.collection('users').doc(realUserId).update({
                        ...profileData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Perfil actualizado en Firebase');
                    
                    // Recargar perfil para mostrar cambios
                    await loadUserProfile();
                }
            } catch (error) {
                console.error('‚ùå Error actualizando perfil:', error);
                throw error;
            }
        }

        // CORREGIDO: Funci√≥n para subir imagen con ID consistente
        async function uploadProfileImage(userId, file) {
            console.log('üñºÔ∏è Uploading image for:', userId);
            
            try {
                const realUserId = window.simulatedUser ? SIMULATED_USER_ID : userId;
                
                // Si Firebase Storage est√° disponible, subir imagen
                if (window.storage) {
                    const fileName = `profile-images/${realUserId}/${Date.now()}_${file.name}`;
                    const storageRef = window.storage.ref(fileName);
                    
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    // Actualizar el perfil con la nueva URL
                    await actualizarPerfil(userId, { avatar: downloadURL });
                    
                    console.log('‚úÖ Imagen subida a Firebase Storage');
                    return downloadURL;
                } else {
                    // Fallback: crear URL local temporal
                    const reader = new FileReader();
                    return new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                }
            } catch (error) {
                console.error('‚ùå Error subiendo imagen:', error);
                throw error;
            }
        }

        // Mantener todas las dem√°s funciones igual...
        // (generatePersonalQR, drawQRCodeToCanvas, etc.)

        // NUEVA: Funci√≥n de debugging para verificar estado
        window.debugProfile = function() {
            console.log('üîç Estado actual del perfil:');
            console.log('  - Usuario actual:', currentUser);
            console.log('  - Usuario simulado:', window.simulatedUser);
            console.log('  - Firebase Auth:', !!window.auth);
            console.log('  - Firebase DB:', !!window.db);
            console.log('  - Firebase Storage:', !!window.storage);
            
            if (currentUser) {
                console.log('  - UID actual:', currentUser.uid);
                const realUserId = window.simulatedUser ? SIMULATED_USER_ID : currentUser.uid;
                console.log('  - ID real usado:', realUserId);
                
                // Intentar recargar perfil
                loadUserProfile();
            }
        };

        console.log('üéâ Perfil cargado completamente con correcciones');
    </script>
</body>
</html>
