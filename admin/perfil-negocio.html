<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas - Perfil del Negocio</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 data-translate="business_profile">Perfil del Negocio</h1>
                <div class="language-toggle">
                    <button class="lang-btn" onclick="changeLanguage('es')" id="lang-es">ES</button>
                    <button class="lang-btn" onclick="changeLanguage('en')" id="lang-en">EN</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Business Header -->
            <div class="business-header">
                <div class="business-image-container">
                    <img id="business-image" src="../images/default-business.svg" alt="Negocio" class="business-image">
                    <button class="edit-image-btn" onclick="changeBusinessImage()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="business-basic-info">
                    <h2 id="business-name" class="business-name">Mi Negocio</h2>
                    <p id="business-category" class="business-category">Restaurante</p>
                    <div class="business-rating">
                        <i class="fas fa-star"></i>
                        <span id="business-rating">4.5</span>
                        <span class="rating-count">(<span id="rating-count">120</span> reseñas)</span>
                    </div>
                </div>
            </div>

            <!-- Business Information Form -->
            <div class="business-form">
                <!-- Non-editable Information -->
                <div class="form-section">
                    <h3 data-translate="business_info">Información del Negocio</h3>
                    
                    <div class="input-group readonly">
                        <label data-translate="business_name">Nombre del negocio</label>
                        <input type="text" id="name-input" class="input-field" readonly>
                        <div class="readonly-note" data-translate="contact_support">Contacta soporte para cambios</div>
                    </div>
                    
                    <div class="input-group readonly">
                        <label data-translate="email">Email</label>
                        <input type="email" id="email-input" class="input-field" readonly>
                        <div class="readonly-note" data-translate="contact_support">Contacta soporte para cambios</div>
                    </div>
                    
                    <div class="input-group readonly">
                        <label data-translate="phone">Teléfono</label>
                        <input type="tel" id="phone-input" class="input-field" readonly>
                        <div class="readonly-note" data-translate="contact_support">Contacta soporte para cambios</div>
                    </div>
                    
                    <div class="input-group readonly">
                        <label data-translate="address">Dirección</label>
                        <textarea id="address-input" class="input-field" readonly rows="3"></textarea>
                        <div class="readonly-note" data-translate="contact_support">Contacta soporte para cambios</div>
                    </div>
                </div>

                <!-- Editable Configuration -->
                <div class="form-section">
                    <h3 data-translate="configuration">Configuración</h3>
                    
                    <div class="input-group">
                        <label data-translate="point_value">Valor por punto (en pesos colombianos)</label>
                        <div class="currency-input">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="point-value" class="input-field" min="1" max="10000" step="1">
                        </div>
                        <div class="input-help" data-translate="point_value_help">Valor monetario que representa cada punto de fidelización</div>
                    </div>
                    
                    <div class="input-group">
                        <label data-translate="google_maps_url">URL de Google Maps</label>
                        <input type="url" id="maps-url" class="input-field" placeholder="https://maps.google.com/...">
                        <div class="input-help" data-translate="maps_url_help">Enlace directo a tu ubicación en Google Maps</div>
                        <button type="button" class="btn-secondary" onclick="testMapsUrl()" data-translate="test_url">Probar enlace</button>
                    </div>

                    <div class="input-group">
                        <label data-translate="business_description">Descripción del negocio</label>
                        <textarea id="business-description" class="input-field" rows="4" placeholder="Describe tu negocio..."></textarea>
                        <div class="input-help" data-translate="description_help">Descripción que verán los clientes</div>
                    </div>

                    <div class="input-group">
                        <label data-translate="business_hours">Horarios de atención</label>
                        <div class="hours-grid">
                            <div class="hour-item">
                                <span class="day-label" data-translate="monday">Lunes</span>
                                <input type="time" class="time-input" id="monday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="monday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="monday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                            <div class="hour-item">
                                <span class="day-label" data-translate="tuesday">Martes</span>
                                <input type="time" class="time-input" id="tuesday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="tuesday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="tuesday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                            <div class="hour-item">
                                <span class="day-label" data-translate="wednesday">Miércoles</span>
                                <input type="time" class="time-input" id="wednesday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="wednesday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="wednesday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                            <div class="hour-item">
                                <span class="day-label" data-translate="thursday">Jueves</span>
                                <input type="time" class="time-input" id="thursday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="thursday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="thursday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                            <div class="hour-item">
                                <span class="day-label" data-translate="friday">Viernes</span>
                                <input type="time" class="time-input" id="friday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="friday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="friday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                            <div class="hour-item">
                                <span class="day-label" data-translate="saturday">Sábado</span>
                                <input type="time" class="time-input" id="saturday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="saturday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="saturday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                            <div class="hour-item">
                                <span class="day-label" data-translate="sunday">Domingo</span>
                                <input type="time" class="time-input" id="sunday-open">
                                <span>-</span>
                                <input type="time" class="time-input" id="sunday-close">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sunday-closed">
                                    <span data-translate="closed">Cerrado</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Statistics -->
                <div class="form-section">
                    <h3 data-translate="statistics">Estadísticas</h3>
                    <div class="stats-grid">
                        <div class="stat-card readonly">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h4 id="total-customers">0</h4>
                                <p data-translate="total_customers">Total clientes</p>
                            </div>
                        </div>
                        <div class="stat-card readonly">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-info">
                                <h4 id="total-points-given">0</h4>
                                <p data-translate="total_points_given">Puntos otorgados</p>
                            </div>
                        </div>
                        <div class="stat-card readonly">
                            <div class="stat-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <div class="stat-info">
                                <h4 id="total-redemptions">0</h4>
                                <p data-translate="total_redemptions">Canjes realizados</p>
                            </div>
                        </div>
                        <div class="stat-card readonly">
                            <div class="stat-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="stat-info">
                                <h4 id="member-since">-</h4>
                                <p data-translate="member_since">Miembro desde</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="form-section">
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveConfiguration()" data-translate="save_changes">Guardar Cambios</button>
                        <button class="btn-secondary" onclick="resetForm()" data-translate="reset">Restablecer</button>
                        <button class="btn-danger" onclick="logout()" data-translate="logout">Cerrar Sesión</button>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p data-translate="loading">Cargando...</p>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="admin-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span data-translate="dashboard">Dashboard</span>
            </a>
            <a href="dar-estrellas.html" class="nav-item">
                <i class="fas fa-star"></i>
                <span data-translate="give_stars">Dar Estrellas</span>
            </a>
            <a href="clientes.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span data-translate="clients">Clientes</span>
            </a>
            <a href="perfil-negocio.html" class="nav-item active">
                <i class="fas fa-store"></i>
                <span data-translate="business_profile">Perfil</span>
            </a>
        </nav>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal" id="image-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="change_business_image">Cambiar Imagen del Negocio</h2>
                <button class="close-btn" onclick="closeImageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-options">
                    <button class="option-btn" onclick="selectImageFromGallery()">
                        <i class="fas fa-image"></i>
                        <span data-translate="select_from_gallery">Seleccionar de la galería</span>
                    </button>
                    <button class="option-btn" onclick="takePhoto()">
                        <i class="fas fa-camera"></i>
                        <span data-translate="take_photo">Tomar foto</span>
                    </button>
                </div>
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <div class="image-guidelines">
                    <h4 data-translate="image_guidelines">Recomendaciones:</h4>
                    <ul>
                        <li data-translate="image_size">Tamaño recomendado: 800x600 píxeles</li>
                        <li data-translate="image_format">Formato: JPG, PNG o WebP</li>
                        <li data-translate="image_quality">Imagen clara y bien iluminada</li>
                        <li data-translate="image_content">Que represente tu negocio</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/translations.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    
    <script>
        let currentUser = null;
        let businessData = null;
        let originalConfiguration = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            updateTexts();
            loadBusinessData();
            setupHoursToggle();
        });

        function checkAuthentication() {
            // [ESPACIO FIREBASE AUTH] - Check if admin is logged in
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = '../index.html';
                return;
            }
        }

        async function loadBusinessData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // [ESPACIO FIREBASE] - Load business data
                businessData = await cargarDatosNegocio(currentUser.uid);
                
                if (businessData) {
                    populateBusinessForm();
                    loadBusinessStatistics();
                }
                
            } catch (error) {
                console.error('Error loading business data:', error);
                showError(error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function populateBusinessForm() {
            if (!businessData) return;
            
            // Header information
            document.getElementById('business-name').textContent = businessData.name || 'Mi Negocio';
            document.getElementById('business-category').textContent = businessData.category || 'Negocio';
            document.getElementById('business-rating').textContent = businessData.rating || '0.0';
            document.getElementById('rating-count').textContent = businessData.ratingCount || '0';
            
            if (businessData.image) {
                document.getElementById('business-image').src = businessData.image;
            }
            
            // Non-editable fields
            document.getElementById('name-input').value = businessData.name || '';
            document.getElementById('email-input').value = businessData.email || '';
            document.getElementById('phone-input').value = businessData.phone || '';
            document.getElementById('address-input').value = businessData.address || '';
            
            // Editable configuration
            document.getElementById('point-value').value = businessData.pointValue || 1000;
            document.getElementById('maps-url').value = businessData.mapsUrl || '';
            document.getElementById('business-description').value = businessData.description || '';
            
            // Business hours
            if (businessData.hours) {
                populateBusinessHours(businessData.hours);
            }
            
            // Store original configuration for reset
            originalConfiguration = {
                pointValue: businessData.pointValue || 1000,
                mapsUrl: businessData.mapsUrl || '',
                description: businessData.description || '',
                hours: businessData.hours || {}
            };
        }

        function populateBusinessHours(hours) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                const dayData = hours[day];
                if (dayData) {
                    if (dayData.closed) {
                        document.getElementById(`${day}-closed`).checked = true;
                        document.getElementById(`${day}-open`).disabled = true;
                        document.getElementById(`${day}-close`).disabled = true;
                    } else {
                        document.getElementById(`${day}-open`).value = dayData.open || '';
                        document.getElementById(`${day}-close`).value = dayData.close || '';
                    }
                }
            });
        }

        async function loadBusinessStatistics() {
            try {
                // [ESPACIO FIREBASE] - Load business statistics
                const stats = await getBusinessStatistics(currentUser.uid);
                
                document.getElementById('total-customers').textContent = stats.totalCustomers || '0';
                document.getElementById('total-points-given').textContent = stats.totalPointsGiven || '0';
                document.getElementById('total-redemptions').textContent = stats.totalRedemptions || '0';
                
                if (businessData.createdAt) {
                    const memberSince = new Date(businessData.createdAt).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long'
                    });
                    document.getElementById('member-since').textContent = memberSince;
                }
                
            } catch (error) {
                console.error('Error loading business statistics:', error);
            }
        }

        function setupHoursToggle() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                const closedCheckbox = document.getElementById(`${day}-closed`);
                const openInput = document.getElementById(`${day}-open`);
                const closeInput = document.getElementById(`${day}-close`);
                
                closedCheckbox.addEventListener('change', function() {
                    openInput.disabled = this.checked;
                    closeInput.disabled = this.checked;
                    
                    if (this.checked) {
                        openInput.value = '';
                        closeInput.value = '';
                    }
                });
            });
        }

        async function saveConfiguration() {
            try {
                const configuration = {
                    pointValue: parseInt(document.getElementById('point-value').value),
                    mapsUrl: document.getElementById('maps-url').value.trim(),
                    description: document.getElementById('business-description').value.trim(),
                    hours: getBusinessHours()
                };
                
                // Validate configuration
                if (configuration.pointValue < 1 || configuration.pointValue > 10000) {
                    throw new Error(t('invalid_point_value'));
                }
                
                if (configuration.mapsUrl && !isValidUrl(configuration.mapsUrl)) {
                    throw new Error(t('invalid_maps_url'));
                }
                
                // [ESPACIO FIREBASE] - Update configuration
                await actualizarConfiguracion(currentUser.uid, configuration);
                
                // Update original configuration
                originalConfiguration = { ...configuration };
                
                showSuccess(t('configuration_saved'));
                
            } catch (error) {
                console.error('Error saving configuration:', error);
                showError(error.message);
            }
        }

        function getBusinessHours() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const hours = {};
            
            days.forEach(day => {
                const closed = document.getElementById(`${day}-closed`).checked;
                const open = document.getElementById(`${day}-open`).value;
                const close = document.getElementById(`${day}-close`).value;
                
                hours[day] = {
                    closed: closed,
                    open: closed ? '' : open,
                    close: closed ? '' : close
                };
            });
            
            return hours;
        }

        function resetForm() {
            if (!originalConfiguration) return;
            
            document.getElementById('point-value').value = originalConfiguration.pointValue;
            document.getElementById('maps-url').value = originalConfiguration.mapsUrl;
            document.getElementById('business-description').value = originalConfiguration.description;
            
            if (originalConfiguration.hours) {
                populateBusinessHours(originalConfiguration.hours);
            }
        }

        function testMapsUrl() {
            const url = document.getElementById('maps-url').value.trim();
            
            if (!url) {
                showError(t('enter_maps_url'));
                return;
            }
            
            if (!isValidUrl(url)) {
                showError(t('invalid_maps_url'));
                return;
            }
            
            window.open(url, '_blank');
        }

        function changeBusinessImage() {
            document.getElementById('image-modal').style.display = 'block';
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = 'none';
        }

        function selectImageFromGallery() {
            document.getElementById('file-input').click();
        }

        function takePhoto() {
            const fileInput = document.getElementById('file-input');
            fileInput.setAttribute('capture', 'camera');
            fileInput.click();
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError(t('invalid_file_type'));
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showError(t('file_too_large'));
                return;
            }
            
            try {
                // [ESPACIO FIREBASE STORAGE] - Upload image
                const imageUrl = await uploadBusinessImage(currentUser.uid, file);
                
                // Update business image
                document.getElementById('business-image').src = imageUrl;
                
                // Update business data
                await actualizarConfiguracion(currentUser.uid, { image: imageUrl });
                
                closeImageModal();
                showSuccess(t('image_updated'));
                
            } catch (error) {
                console.error('Error uploading image:', error);
                showError(error.message);
            }
        }

        async function logout() {
            if (confirm(t('confirm_logout'))) {
                try {
                    // [ESPACIO FIREBASE AUTH] - Sign out user
                    await signOut();
                    window.location.href = '../index.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    showError(error.message);
                }
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showError(message) {
            alert(message);
        }

        function showSuccess(message) {
            alert(message);
        }

        function getCurrentUser() {
            // [ESPACIO FIREBASE AUTH] - Get current authenticated user
            return null;
        }

        // [ESPACIO FIREBASE] - Firebase functions to implement
        async function cargarDatosNegocio(businessId) {
            // Load business data from Firestore
            console.log('Loading business data for:', businessId);
            
            return {
                name: 'Mi Negocio',
                category: 'Restaurante',
                email: 'admin@negocio.com',
                phone: '+57 1 234 5678',
                address: 'Calle 123 #45-67, Bogotá, Colombia',
                pointValue: 1000,
                mapsUrl: '',
                description: '',
                hours: {},
                rating: 4.5,
                ratingCount: 120,
                createdAt: new Date().toISOString()
            };
        }

        async function getBusinessStatistics(businessId) {
            // Get business statistics from Firestore
            console.log('Loading business statistics for:', businessId);
            
            return {
                totalCustomers: 0,
                totalPointsGiven: 0,
                totalRedemptions: 0
            };
        }

        async function actualizarConfiguracion(businessId, configuration) {
            // Update business configuration in Firestore
            console.log('Updating business configuration:', businessId, configuration);
        }

        async function uploadBusinessImage(businessId, file) {
            // Upload business image to Firebase Storage
            console.log('Uploading business image for:', businessId);
            return '../images/default-business.svg';
        }

        async function signOut() {
            // Sign out user from Firebase Auth
            console.log('Signing out user');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target === modal) {
                closeImageModal();
            }
        }
    </script>
</body>
</html>
