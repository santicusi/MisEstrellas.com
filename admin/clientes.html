<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas - Gestionar Clientes</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 data-translate="manage_clients">Gestionar Clientes</h1>
                <div class="language-toggle">
                    <button class="lang-btn" onclick="changeLanguage('es')" id="lang-es">ES</button>
                    <button class="lang-btn" onclick="changeLanguage('en')" id="lang-en">EN</button>
                </div>
            </div>
        </header>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Buscar clientes..." data-translate-placeholder="search_clients">
                <button class="scan-btn" onclick="openQRScanner()" title="Escanear QR del cliente">
                    <i class="fas fa-qrcode"></i>
                </button>
            </div>
            <div class="search-filters">
                <select id="sort-filter" onchange="applySortFilter()">
                    <option value="name" data-translate="sort_by_name">Ordenar por nombre</option>
                    <option value="points" data-translate="sort_by_points">Ordenar por puntos</option>
                    <option value="recent" data-translate="sort_by_recent">Más recientes</option>
                    <option value="frequent" data-translate="sort_by_frequent">Más frecuentes</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Client Statistics -->
            <div class="clients-stats">
                <div class="stats-card">
                    <div class="stat-item">
                        <span class="stat-number" id="total-clients">0</span>
                        <span class="stat-label" data-translate="total_clients">Total clientes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="active-clients">0</span>
                        <span class="stat-label" data-translate="active_this_month">Activos este mes</span>
                    </div>
                </div>
            </div>

            <!-- Clients List -->
            <div class="clients-list" id="clients-list">
                <!-- Client cards will be populated by JavaScript -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <i class="fas fa-users"></i>
                <h3 data-translate="no_clients">No hay clientes</h3>
                <p data-translate="no_clients_message">Aún no tienes clientes registrados en tu negocio</p>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p data-translate="loading">Cargando...</p>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="admin-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span data-translate="dashboard">Dashboard</span>
            </a>
            <a href="dar-estrellas.html" class="nav-item">
                <i class="fas fa-star"></i>
                <span data-translate="give_stars">Dar Estrellas</span>
            </a>
            <a href="clientes.html" class="nav-item active">
                <i class="fas fa-users"></i>
                <span data-translate="clients">Clientes</span>
            </a>
            <a href="perfil-negocio.html" class="nav-item">
                <i class="fas fa-store"></i>
                <span data-translate="business_profile">Perfil</span>
            </a>
        </nav>
    </div>

    <!-- Client Management Modal -->
    <div class="modal" id="client-modal">
        <div class="modal-content large">
            <div class="modal-header">
                <div class="client-header-info">
                    <img id="modal-client-avatar" src="../images/default-avatar.svg" alt="Cliente" class="client-avatar">
                    <div class="client-basic-info">
                        <h2 id="modal-client-name">Cliente</h2>
                        <p id="modal-client-contact">+57 300 123 4567</p>
                    </div>
                </div>
                <button class="close-btn" onclick="closeClientModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Client Stats -->
                <div class="client-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="modal-client-points">0</h4>
                            <p data-translate="total_points">Puntos totales</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="modal-client-visits">0</h4>
                            <p data-translate="total_visits">Visitas totales</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h4 id="modal-client-last-visit">-</h4>
                            <p data-translate="last_visit">Última visita</p>
                        </div>
                    </div>
                </div>

                <!-- Redeem Points Section -->
                <div class="redeem-section">
                    <h3 data-translate="redeem_points">Canjear Puntos</h3>
                    <div class="redeem-controls">
                        <div class="points-input">
                            <label data-translate="points_to_redeem">Puntos a canjear:</label>
                            <div class="input-with-controls">
                                <button class="control-btn" onclick="decrementRedeemPoints()">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" id="redeem-points" value="1" min="1" max="100">
                                <button class="control-btn" onclick="incrementRedeemPoints()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="redeemPoints()" data-translate="redeem">Canjear</button>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="history-section">
                    <h3 data-translate="transaction_history">Historial de Transacciones</h3>
                    <div class="history-list" id="modal-transaction-history">
                        <!-- History items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal" id="qr-scanner-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="scan_client_qr">Escanear QR del Cliente</h2>
                <button class="close-btn" onclick="closeQRScanner()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="scanner-container">
                    <video id="scanner-video" autoplay playsinline></video>
                    <div class="scan-overlay">
                        <div class="scan-frame">
                            <div class="scan-corners">
                                <div class="corner top-left"></div>
                                <div class="corner top-right"></div>
                                <div class="corner bottom-left"></div>
                                <div class="corner bottom-right"></div>
                            </div>
                        </div>
                    </div>
                    <canvas id="scanner-canvas" style="display: none;"></canvas>
                </div>
                <div class="scanner-status">
                    <p id="scanner-status-text" data-translate="scanning_qr">Buscando código QR...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <script src="../js/translations.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    
    <script>
        let currentUser = null;
        let clients = [];
        let filteredClients = [];
        let selectedClient = null;
        let scannerStream = null;
        let scannerActive = false;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            updateTexts();
            loadClients();
            setupSearchFunctionality();
        });

        function checkAuthentication() {
            // [ESPACIO FIREBASE AUTH] - Check if admin is logged in
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = '../index.html';
                return;
            }
        }

        async function loadClients() {
            const loading = document.getElementById('loading');
            const clientsList = document.getElementById('clients-list');
            const emptyState = document.getElementById('empty-state');
            
            loading.style.display = 'block';
            
            try {
                // [ESPACIO FIREBASE] - Load clients from Firestore
                clients = await cargarClientes(currentUser.uid);
                filteredClients = [...clients];
                
                if (clients.length === 0) {
                    showEmptyState();
                } else {
                    displayClients();
                    updateClientStats();
                }
                
            } catch (error) {
                console.error('Error loading clients:', error);
                showError(error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayClients() {
            const clientsList = document.getElementById('clients-list');
            const emptyState = document.getElementById('empty-state');
            
            clientsList.innerHTML = '';
            emptyState.style.display = 'none';
            
            filteredClients.forEach(client => {
                const clientCard = createClientCard(client);
                clientsList.appendChild(clientCard);
            });
        }

        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'client-card';
            card.onclick = () => showClientDetail(client);
            
            const lastVisit = client.lastVisit ? formatDate(client.lastVisit) : 'Nunca';
            
            card.innerHTML = `
                <div class="client-avatar">
                    <img src="${client.avatar || '../images/default-avatar.svg'}" alt="${client.name}">
                </div>
                <div class="client-info">
                    <h3 class="client-name">${client.name || 'Cliente'}</h3>
                    <p class="client-contact">${client.phone || client.email}</p>
                    <div class="client-stats-mini">
                        <span class="stat-item">
                            <i class="fas fa-star"></i>
                            ${client.points || 0}
                        </span>
                        <span class="stat-item">
                            <i class="fas fa-calendar"></i>
                            ${client.visits || 0} visitas
                        </span>
                    </div>
                </div>
                <div class="client-actions">
                    <div class="client-status ${client.isActive ? 'active' : 'inactive'}">
                        ${client.isActive ? 'Activo' : 'Inactivo'}
                    </div>
                    <div class="last-visit">${lastVisit}</div>
                </div>
            `;
            
            return card;
        }

        function showClientDetail(client) {
            selectedClient = client;
            const modal = document.getElementById('client-modal');
            
            // Populate modal with client data
            document.getElementById('modal-client-name').textContent = client.name || 'Cliente';
            document.getElementById('modal-client-contact').textContent = client.phone || client.email;
            document.getElementById('modal-client-avatar').src = client.avatar || '../images/default-avatar.svg';
            document.getElementById('modal-client-points').textContent = client.points || 0;
            document.getElementById('modal-client-visits').textContent = client.visits || 0;
            document.getElementById('modal-client-last-visit').textContent = client.lastVisit ? formatDate(client.lastVisit) : 'Nunca';
            
            // Set max redeem points
            const redeemInput = document.getElementById('redeem-points');
            redeemInput.max = client.points || 0;
            redeemInput.value = Math.min(1, client.points || 0);
            
            // Load transaction history
            loadClientTransactionHistory(client.id);
            
            modal.style.display = 'block';
        }

        async function loadClientTransactionHistory(clientId) {
            const historyContainer = document.getElementById('modal-transaction-history');
            historyContainer.innerHTML = '<div class="loading-small"><div class="spinner-small"></div></div>';
            
            try {
                // [ESPACIO FIREBASE] - Load client transaction history
                const transactions = await getClientTransactionHistory(clientId, currentUser.uid);
                
                if (transactions.length === 0) {
                    historyContainer.innerHTML = `<p class="no-transactions" data-translate="no_transactions">No hay transacciones</p>`;
                } else {
                    historyContainer.innerHTML = transactions.map(transaction => `
                        <div class="transaction-item ${transaction.type}">
                            <div class="transaction-icon">
                                <i class="fas ${transaction.type === 'earned' ? 'fa-plus' : 'fa-minus'}"></i>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-description">${transaction.description}</div>
                                <div class="transaction-date">${formatDate(transaction.date)}</div>
                            </div>
                            <div class="transaction-amount ${transaction.type}">
                                ${transaction.type === 'earned' ? '+' : '-'}${transaction.points}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                historyContainer.innerHTML = `<p class="error" data-translate="error_loading">Error al cargar historial</p>`;
            }
        }

        function updateClientStats() {
            const totalClients = clients.length;
            const activeClients = clients.filter(client => client.isActive).length;
            
            document.getElementById('total-clients').textContent = totalClients;
            document.getElementById('active-clients').textContent = activeClients;
        }

        function setupSearchFunctionality() {
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchClients(this.value);
                }, 300);
            });
        }

        function searchClients(query) {
            if (!query.trim()) {
                filteredClients = [...clients];
            } else {
                filteredClients = clients.filter(client => 
                    (client.name && client.name.toLowerCase().includes(query.toLowerCase())) ||
                    (client.phone && client.phone.includes(query)) ||
                    (client.email && client.email.toLowerCase().includes(query.toLowerCase()))
                );
            }
            
            displayClients();
        }

        function applySortFilter() {
            const sortBy = document.getElementById('sort-filter').value;
            
            filteredClients.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'points':
                        return (b.points || 0) - (a.points || 0);
                    case 'recent':
                        return new Date(b.lastVisit || 0) - new Date(a.lastVisit || 0);
                    case 'frequent':
                        return (b.visits || 0) - (a.visits || 0);
                    default:
                        return 0;
                }
            });
            
            displayClients();
        }

        function decrementRedeemPoints() {
            const input = document.getElementById('redeem-points');
            const value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
            }
        }

        function incrementRedeemPoints() {
            const input = document.getElementById('redeem-points');
            const value = parseInt(input.value);
            const max = parseInt(input.max);
            if (value < max) {
                input.value = value + 1;
            }
        }

        async function redeemPoints() {
            const pointsToRedeem = parseInt(document.getElementById('redeem-points').value);
            
            if (!selectedClient || pointsToRedeem <= 0 || pointsToRedeem > selectedClient.points) {
                showError(t('invalid_redeem_amount'));
                return;
            }
            
            if (!confirm(t('confirm_redeem_points').replace('{points}', pointsToRedeem).replace('{client}', selectedClient.name))) {
                return;
            }
            
            try {
                // [ESPACIO FIREBASE] - Process point redemption
                await procesarCanje(selectedClient.id, pointsToRedeem);
                
                // Update client data
                selectedClient.points -= pointsToRedeem;
                
                // Refresh display
                document.getElementById('modal-client-points').textContent = selectedClient.points;
                document.getElementById('redeem-points').max = selectedClient.points;
                document.getElementById('redeem-points').value = Math.min(1, selectedClient.points);
                
                // Reload transaction history
                loadClientTransactionHistory(selectedClient.id);
                
                // Refresh clients list
                loadClients();
                
                showSuccess(t('points_redeemed_successfully'));
                
            } catch (error) {
                console.error('Error redeeming points:', error);
                showError(error.message);
            }
        }

        function openQRScanner() {
            const modal = document.getElementById('qr-scanner-modal');
            modal.style.display = 'block';
            startQRScanner();
        }

        function closeQRScanner() {
            const modal = document.getElementById('qr-scanner-modal');
            modal.style.display = 'none';
            stopQRScanner();
        }

        async function startQRScanner() {
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('scanner-canvas');
            const context = canvas.getContext('2d');
            
            try {
                scannerStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                video.srcObject = scannerStream;
                scannerActive = true;
                
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    scanFrame();
                });
                
            } catch (error) {
                console.error('Error starting QR scanner:', error);
                showError(t('camera_error'));
            }
        }

        function scanFrame() {
            if (!scannerActive) return;
            
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('scanner-canvas');
            const context = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    handleScannedQR(code.data);
                    return;
                }
            }
            
            requestAnimationFrame(scanFrame);
        }

        async function handleScannedQR(qrData) {
            try {
                // [ESPACIO FIREBASE] - Process scanned client QR
                const clientData = await processClientQR(qrData);
                
                if (clientData) {
                    closeQRScanner();
                    showClientDetail(clientData);
                } else {
                    showError(t('invalid_client_qr'));
                }
                
            } catch (error) {
                console.error('Error processing scanned QR:', error);
                showError(error.message);
            }
        }

        function stopQRScanner() {
            scannerActive = false;
            
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
        }

        function closeClientModal() {
            document.getElementById('client-modal').style.display = 'none';
            selectedClient = null;
        }

        function showEmptyState() {
            const clientsList = document.getElementById('clients-list');
            const emptyState = document.getElementById('empty-state');
            
            clientsList.innerHTML = '';
            emptyState.style.display = 'block';
        }

        function showError(message) {
            alert(message);
        }

        function showSuccess(message) {
            alert(message);
        }

        function getCurrentUser() {
            // [ESPACIO FIREBASE AUTH] - Get current authenticated user
            return null;
        }

        // [ESPACIO FIREBASE] - Firebase functions to implement
        async function cargarClientes(businessId) {
            // Query clients for this business from Firestore
            console.log('Loading clients for business:', businessId);
            return [];
        }

        async function getClientTransactionHistory(clientId, businessId) {
            // Get transaction history for client and business
            console.log('Loading transaction history for client:', clientId, 'business:', businessId);
            return [];
        }

        async function procesarCanje(clientId, points) {
            // Process point redemption transaction
            console.log('Processing redemption for client:', clientId, 'points:', points);
        }

        async function processClientQR(qrData) {
            // Process scanned client QR code
            console.log('Processing client QR:', qrData);
            return null;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const clientModal = document.getElementById('client-modal');
            const scannerModal = document.getElementById('qr-scanner-modal');
            
            if (event.target === clientModal) {
                closeClientModal();
            }
            
            if (event.target === scannerModal) {
                closeQRScanner();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopQRScanner();
        });
    </script>
</body>
</html>
