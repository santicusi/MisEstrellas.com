<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas - Dar Estrellas</title>
    <!-- SDKs de Firebase compatibles con navegadores normales (sin bundler) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>

<style>
    :root {
    /* Variables principales que faltan */
    --bg-black: #0F0F0F;
    --text-white: #FFFFFF;
    --success-green: #4CAF50;
    --error-red: #F44336;
    --warning-yellow: #FFC107;
    
    /* Colores mejorados */
    --primary-orange: #FF8C42;
    --hover-orange: #FF7A2B;
    --accent-orange: #FFA366;
    --dark-orange: #E67A35;
    
    /* Tonos cálidos en lugar de grises */
    --warm-gray: #2A2A2A;
    --light-warm: #363636;
    --card-warm: #1F1F1F;
    --border-warm: #404040;
    --secondary-gray: #AAA;
    
    /* Gradientes */
    --gradient-card: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
    --gradient-orange: linear-gradient(135deg, #FF8C42 0%, #FFA366 100%);
    --gradient-dark: linear-gradient(135deg, #0F0F0F 0%, #1F1F1F 100%);
    
    /* Actualizar variables existentes */
    --card-bg: var(--gradient-card);
    --border-color: var(--border-warm);
    --input-bg: var(--warm-gray);
    --shadow-dark: rgba(0, 0, 0, 0.3);
    --shadow-orange: rgba(255, 140, 66, 0.2);
}

/* Debug button */
.debug-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--primary-orange);
    border: none;
    color: white;
    padding: 12px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
</style>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 data-translate="give_stars">Dar Estrellas</h1>
                <div class="language-toggle">
                    <button class="lang-btn" onclick="changeLanguage('es')" id="lang-es">ES</button>
                    <button class="lang-btn" onclick="changeLanguage('en')" id="lang-en">EN</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Points Counter -->
            <div class="points-section">
                <div class="points-card">
                    <h2 data-translate="select_points">Seleccionar Puntos</h2>
                    <div class="points-counter">
                        <button class="counter-btn" onclick="decrementPoints()" id="decrement-btn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <div class="points-display">
                            <span class="points-number" id="points-number">1</span>
                            <i class="fas fa-star"></i>
                        </div>
                        <button class="counter-btn" onclick="incrementPoints()" id="increment-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="points-presets">
                        <button class="preset-btn" onclick="setPoints(1)">1</button>
                        <button class="preset-btn" onclick="setPoints(5)">5</button>
                        <button class="preset-btn" onclick="setPoints(10)">10</button>
                        <button class="preset-btn" onclick="setPoints(25)">25</button>
                    </div>
                </div>
            </div>

            <!-- Generate QR Section -->
            <div class="qr-section">
                <div class="qr-card">
                    <h2 data-translate="generate_qr">Generar Código QR</h2>
                    <div class="qr-container" id="qr-container">
                        <div class="qr-placeholder" id="qr-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <p data-translate="qr_placeholder">El código QR aparecerá aquí</p>
                            <button class="btn-primary" onclick="generateQR()" data-translate="create_qr">Crear QR</button>
                        </div>
                        <div class="qr-code-display" id="qr-code-display" style="display: none;">
                            <div class="qr-code" id="qr-code"></div>
                            <div class="qr-info">
                                <p class="qr-points">
                                    <i class="fas fa-star"></i>
                                    <span id="qr-points-display">1</span>
                                    <span data-translate="points">puntos</span>
                                </p>
                                <p class="qr-code-text" id="qr-code-text">ABC123</p>
                                <p class="qr-expires" data-translate="expires_in">Expira en: <span id="qr-expires-time">5:00</span></p>
                            </div>
                            <div class="qr-actions">
                                <button class="btn-secondary" onclick="regenerateQR()" data-translate="regenerate">Regenerar</button>
                                <button class="btn-secondary" onclick="clearQR()" data-translate="clear">Limpiar</button>
                            </div>
                        </div>
                        <div class="qr-loading" id="qr-loading" style="display: none;">
                            <div class="spinner"></div>
                            <p data-translate="generating_qr">Generando código QR...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions-section">
                <h3 data-translate="instructions">Instrucciones</h3>
                <div class="instructions-list">
                    <div class="instruction-item">
                        <div class="instruction-number">1</div>
                        <p data-translate="instruction_select">Selecciona la cantidad de puntos a otorgar</p>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">2</div>
                        <p data-translate="instruction_generate">Genera el código QR haciendo clic en "Crear QR"</p>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">3</div>
                        <p data-translate="instruction_scan">El cliente debe escanear el código con su aplicación</p>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">4</div>
                        <p data-translate="instruction_confirm">Confirma la transacción cuando aparezca la notificación</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="admin-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span data-translate="dashboard">Dashboard</span>
            </a>
            <a href="dar-estrellas.html" class="nav-item active">
                <i class="fas fa-star"></i>
                <span data-translate="give_stars">Dar Estrellas</span>
            </a>
            <a href="clientes.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span data-translate="clients">Clientes</span>
            </a>
            <a href="perfil-negocio.html" class="nav-item">
                <i class="fas fa-store"></i>
                <span data-translate="business_profile">Perfil</span>
            </a>
        </nav>
    </div>

    <!-- Debug Button -->
    <button class="debug-btn" onclick="showDebugInfo()" title="Info Debug">
        <i class="fas fa-bug"></i>
    </button>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="confirm_transaction">Confirmar Transacción</h2>
            </div>
            <div class="modal-body">
                <div class="client-info">
                    <div class="client-avatar">
                        <img id="modal-client-avatar" src="../images/default-avatar.svg" alt="Cliente">
                    </div>
                    <div class="client-details">
                        <h3 id="modal-client-name">Cliente</h3>
                        <p id="modal-client-contact">+57 300 123 4567</p>
                    </div>
                </div>
                <div class="transaction-details">
                    <div class="transaction-item">
                        <span data-translate="points_to_give">Puntos a otorgar:</span>
                        <span class="transaction-value">
                            <i class="fas fa-star"></i>
                            <span id="modal-points">1</span>
                        </span>
                    </div>
                    <div class="transaction-item">
                        <span data-translate="business">Negocio:</span>
                        <span class="transaction-value" id="modal-business">Mi Negocio</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeConfirmationModal()" data-translate="cancel">Cancelar</button>
                    <button class="btn-primary" onclick="confirmTransaction()" data-translate="confirm">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="success">¡Éxito!</h2>
            </div>
            <div class="modal-body">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="success-message">
                    <p data-translate="transaction_completed">Transacción completada exitosamente</p>
                    <div class="success-details">
                        <p>
                            <span id="success-points">1</span>
                            <span data-translate="points_given_to">puntos otorgados a</span>
                            <span id="success-client">Cliente</span>
                        </p>
                    </div>
                </div>
                <button class="btn-primary" onclick="closeSuccessModal()" data-translate="continue">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/qrcode.min.js"></script>
    <script src="../js/translations.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACIÓN FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAdRYp6pQRVoPnhOEnz3PrYPz8B2jswo3Y",
            authDomain: "miestrellas-d677e.firebaseapp.com",
            projectId: "miestrellas-d677e",
            storageBucket: "miestrellas-d677e.firebasestorage.app",
            messagingSenderId: "942296067880",
            appId: "1:942296067880:web:b5c9e6a7c03d06aa07aa1d"
        };

        // Variables globales
        let app, auth, db, storage;
        let currentUser = null;
        let currentPoints = 1;
        let currentQRCode = null;
        let qrExpirationTimer = null;
        let qrUsageListener = null;
        let businessData = null;

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando dar-estrellas.html');
            initializeApp();
        });

        async function initializeApp() {
            try {
                await initializeFirebase();
                await initializeAuth();
                await loadBusinessData();
                updateTexts();
                updatePointsDisplay();
                updateButtonStates();
                console.log('✅ Aplicación inicializada correctamente');
            } catch (error) {
                console.error('❌ Error inicializando:', error);
                showError('Error inicializando: ' + error.message);
            }
        }

        async function initializeFirebase() {
            console.log('🔥 Inicializando Firebase...');
            
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK no está cargado');
            }

            if (firebase.apps.length === 0) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }

            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();

            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            console.log('✅ Firebase inicializado');
        }

        async function initializeAuth() {
            console.log('🔐 Verificando autenticación...');
            
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    // Modo demo para testing
                    currentUser = { 
                        uid: 'demo-business-' + Date.now(),
                        displayName: 'Negocio Demo',
                        email: 'negocio@demo.com'
                    };
                    console.log('🧪 Usando usuario demo:', currentUser.uid);
                    resolve();
                }, 3000);

                const unsubscribe = auth.onAuthStateChanged((user) => {
                    clearTimeout(timeout);
                    unsubscribe();
                    
                    if (user) {
                        currentUser = user;
                        console.log('✅ Usuario autenticado:', user.uid);
                    } else {
                        currentUser = { 
                            uid: 'demo-business-' + Date.now(),
                            displayName: 'Negocio Demo',
                            email: 'negocio@demo.com'
                        };
                        console.log('🧪 Usuario demo creado:', currentUser.uid);
                    }
                    resolve();
                });
            });
        }

        async function loadBusinessData() {
            try {
                console.log('🏪 Cargando datos del negocio...');
                
                if (db && currentUser) {
                    const businessDoc = await db.collection('businesses').doc(currentUser.uid).get();
                    
                    if (businessDoc.exists) {
                        businessData = businessDoc.data();
                    } else {
                        businessData = {
                            name: 'Mi Negocio Demo',
                            address: 'Dirección Demo',
                            description: 'Negocio de prueba'
                        };
                    }
                } else {
                    businessData = {
                        name: 'Mi Negocio Demo',
                        address: 'Dirección Demo'
                    };
                }
                
                console.log('✅ Datos del negocio:', businessData);
            } catch (error) {
                console.error('❌ Error cargando negocio:', error);
                businessData = { name: 'Mi Negocio', address: 'Dirección' };
            }
        }

        // ============================================
        // FUNCIONES DE PUNTOS
        // ============================================
        function incrementPoints() {
            if (currentPoints < 100) {
                currentPoints++;
                updatePointsDisplay();
                updateButtonStates();
            }
        }

        function decrementPoints() {
            if (currentPoints > 1) {
                currentPoints--;
                updatePointsDisplay();
                updateButtonStates();
            }
        }

        function setPoints(points) {
            currentPoints = points;
            updatePointsDisplay();
            updateButtonStates();
            
            // Highlight the selected preset
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        function updatePointsDisplay() {
            document.getElementById('points-number').textContent = currentPoints;
        }

        function updateButtonStates() {
            const decrementBtn = document.getElementById('decrement-btn');
            const incrementBtn = document.getElementById('increment-btn');
            
            decrementBtn.disabled = currentPoints <= 1;
            incrementBtn.disabled = currentPoints >= 100;
        }

        // ============================================
        // GENERACIÓN DE QR
        // ============================================
        async function generateQR() {
            console.log('📱 Generando QR para', currentPoints, 'puntos');
            
            if (typeof QRCode === 'undefined') {
                showError('Librería QR no cargada, intenta de nuevo');
                return;
            }
            
            const qrPlaceholder = document.getElementById('qr-placeholder');
            const qrDisplay = document.getElementById('qr-code-display');
            const qrLoading = document.getElementById('qr-loading');
            
            // Mostrar loading
            qrPlaceholder.style.display = 'none';
            qrDisplay.style.display = 'none';
            qrLoading.style.display = 'block';
            
            try {
                if (!currentUser) {
                    throw new Error('Usuario no autenticado');
                }
                
                // Generar códigos
                const qrId = 'qr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const displayCode = generateDisplayCode();
                const fullQRCode = `POINTS:${currentUser.uid}:${qrId}:${currentPoints}`;
                
                console.log('🎯 Códigos generados:');
                console.log('   - QR ID:', qrId);
                console.log('   - Display:', displayCode);
                console.log('   - QR Completo:', fullQRCode);
                
                // Guardar en Firebase (solo si está disponible)
                if (db) {
                    const expiresAt = new Date(Date.now() + (5 * 60 * 1000));
                    await db.collection('qr_codes').doc(qrId).set({
                        id: qrId,
                        businessId: currentUser.uid,
                        points: currentPoints,
                        displayCode: displayCode,
                        fullCode: fullQRCode,
                        used: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                        status: 'active'
                    });
                    console.log('💾 QR guardado en Firebase');
                }
                
                // Generar QR visual con el código COMPLETO
                const qrCodeElement = document.getElementById('qr-code');
                qrCodeElement.innerHTML = '';
                
                const qrCode = new QRCode(qrCodeElement, {
                    text: fullQRCode, // ✅ CÓDIGO COMPLETO
                    width: 250,
                    height: 250,
                    colorDark: '#FF8C42',
                    colorLight: '#1A1A1A',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Mostrar información
                document.getElementById('qr-points-display').textContent = currentPoints;
                document.getElementById('qr-code-text').textContent = displayCode;
                
                // Mostrar QR
                qrLoading.style.display = 'none';
                qrDisplay.style.display = 'block';
                
                // Timer y listener
                startExpirationTimer(300);
                if (db) {
                    listenForQRScans(qrId);
                }
                
                currentQRCode = { 
                    id: qrId, 
                    code: fullQRCode, 
                    displayCode: displayCode,
                    points: currentPoints,
                    businessId: currentUser.uid
                };
                
                console.log('✅ QR generado exitosamente');
                
            } catch (error) {
                console.error('❌ Error generando QR:', error);
                qrLoading.style.display = 'none';
                qrPlaceholder.style.display = 'block';
                showError('Error generando QR: ' + error.message);
            }
        }

        function generateDisplayCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function startExpirationTimer(expiresIn) {
            let timeLeft = expiresIn;
            const timerElement = document.getElementById('qr-expires-time');
            
            qrExpirationTimer = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(qrExpirationTimer);
                    expireQR();
                }
            }, 1000);
        }

        function expireQR() {
            console.log('⏰ QR expirado');
            clearQR();
            showError('El código QR ha expirado');
        }

        function regenerateQR() {
            clearQR();
            generateQR();
        }

        function clearQR() {
            const qrPlaceholder = document.getElementById('qr-placeholder');
            const qrDisplay = document.getElementById('qr-code-display');
            
            qrDisplay.style.display = 'none';
            qrPlaceholder.style.display = 'block';
            
            // Limpiar timer
            if (qrExpirationTimer) {
                clearInterval(qrExpirationTimer);
                qrExpirationTimer = null;
            }
            
            // Limpiar listener
            if (qrUsageListener) {
                qrUsageListener();
                qrUsageListener = null;
            }
            
            // Limpiar datos del QR
            currentQRCode = null;
        }

        // ============================================
        // LISTENERS Y CONFIRMACIONES
        // ============================================
        function listenForQRScans(qrId) {
            if (!db) return;
            
            console.log('👂 Escuchando uso del QR:', qrId);
            
            try {
                qrUsageListener = db.collection('qr_codes').doc(qrId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log('🔄 QR actualizado:', data);
                            
                            if (data.used && data.usedBy) {
                                console.log('🎉 QR fue usado por:', data.usedBy);
                                onQRScanned(data);
                            }
                        }
                    }, (error) => {
                        console.error('❌ Error escuchando QR:', error);
                    });
                
            } catch (error) {
                console.error('❌ Error configurando listener:', error);
            }
        }

        async function onQRScanned(qrData) {
            console.log('📱 Cliente escaneó QR:', qrData);
            
            try {
                let clientData = {
                    name: 'Cliente',
                    phone: 'No disponible',
                    email: '',
                    avatar: null
                };

                if (qrData.clientData) {
                    clientData = qrData.clientData;
                } else if (qrData.usedBy && db) {
                    const userDoc = await db.collection('users').doc(qrData.usedBy).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        clientData = {
                            name: userData.name || userData.displayName || 'Cliente',
                            phone: userData.phoneNumber || 'No disponible',
                            email: userData.email || '',
                            avatar: userData.avatar || null
                        };
                    }
                }
                
                showConfirmationModal(clientData);
                
            } catch (error) {
                console.error('❌ Error obteniendo datos del cliente:', error);
                showConfirmationModal({
                    name: 'Cliente',
                    phone: 'No disponible',
                    email: '',
                    avatar: null
                });
            }
        }

        function showConfirmationModal(clientData) {
            console.log('💫 Mostrando confirmación para:', clientData);
            
            const modal = document.getElementById('confirmation-modal');
            
            // Llenar modal con datos del cliente
            document.getElementById('modal-client-name').textContent = clientData.name || 'Cliente';
            document.getElementById('modal-client-contact').textContent = clientData.phone || clientData.email || 'No disponible';
            document.getElementById('modal-client-avatar').src = clientData.avatar || '../images/default-avatar.svg';
            document.getElementById('modal-points').textContent = currentPoints;
            document.getElementById('modal-business').textContent = businessData?.name || 'Mi Negocio';
            
            modal.style.display = 'block';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        async function confirmTransaction() {
            console.log('✅ Confirmando transacción...');
            
            try {
                closeConfirmationModal();
                showSuccessModal();
                clearQR();
                
            } catch (error) {
                console.error('❌ Error confirmando transacción:', error);
                showError('Error confirmando transacción: ' + error.message);
            }
        }

        function showSuccessModal() {
            const modal = document.getElementById('success-modal');
            
            document.getElementById('success-points').textContent = currentPoints;
            document.getElementById('success-client').textContent = document.getElementById('modal-client-name').textContent;
            
            modal.style.display = 'block';
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').style.display = 'none';
        }

        // ============================================
        // FUNCIONES DE UI Y UTILIDADES
        // ============================================
        function showError(message) {
            console.error('🚨 Error:', message);
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                max-width: 400px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        function updateTexts() {
            console.log('🌐 Actualizando textos...');
        }

        // ============================================
        // FUNCIONES DE DEBUG
        // ============================================
        function showDebugInfo() {
            const info = {
                firebase: typeof firebase !== 'undefined',
                auth: !!auth,
                db: !!db,
                currentUser: !!currentUser,
                currentQRCode: !!currentQRCode,
                qrCode: currentQRCode?.code || 'No generado',
                points: currentPoints,
                businessData: !!businessData
            };

            const infoText = Object.entries(info)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');

            alert('🔍 DEBUG INFO:\n\n' + infoText + '\n\n' + 
                  (currentQRCode ? `\nÚltimo QR generado:\n${currentQRCode.code}` : ''));
            
            console.log('🔍 Debug Info:', info);
            
            if (currentQRCode) {
                console.log('📱 Último QR:', currentQRCode.code);
                console.log('💡 Para probar: copia este código y úsalo en el escáner manual');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const confirmationModal = document.getElementById('confirmation-modal');
            const successModal = document.getElementById('success-modal');
            
            if (event.target === confirmationModal) {
                closeConfirmationModal();
            }
            
            if (event.target === successModal) {
                closeSuccessModal();
            }
        }

        // Limpieza al salir de la página
        window.addEventListener('beforeunload', function() {
            if (qrExpirationTimer) {
                clearInterval(qrExpirationTimer);
            }
            
            if (qrUsageListener) {
                qrUsageListener();
            }
        });

        // ============================================
        // FUNCIONES GLOBALES PARA DEBUG
        // ============================================
        
        // Test de confirmación manual
        window.testConfirmation = function() {
            showConfirmationModal({
                name: 'Juan Pérez Test',
                phone: '+57 300 123 4567',
                email: 'juan@test.com',
                avatar: null
            });
        };

        // Obtener último QR generado
        window.getLastQR = function() {
            if (currentQRCode) {
                console.log('📱 Último QR generado:', currentQRCode.code);
                navigator.clipboard.writeText(currentQRCode.code).then(() => {
                    console.log('📋 Código copiado al portapapeles');
                    showSuccess('Código QR copiado al portapapeles');
                }).catch(() => {
                    console.log('❌ No se pudo copiar al portapapeles');
                });
                return currentQRCode.code;
            } else {
                console.log('❌ No hay QR generado');
                return null;
            }
        };

        // Validar formato QR
        window.validateQR = function(qrCode) {
            if (!qrCode && currentQRCode) {
                qrCode = currentQRCode.code;
            }
            
            if (!qrCode) {
                console.log('❌ No hay código QR para validar');
                return false;
            }

            const parts = qrCode.split(':');
            const isValid = parts.length === 4 && parts[0] === 'POINTS';
            
            console.log('🔍 Validando QR:', qrCode);
            console.log('Partes:', parts);
            console.log('Es válido:', isValid);
            
            if (isValid) {
                console.log('✅ Formato correcto:');
                console.log('  - Tipo:', parts[0]);
                console.log('  - Business ID:', parts[1]);
                console.log('  - QR ID:', parts[2]);
                console.log('  - Puntos:', parts[3]);
            }
            
            return isValid;
        };

        console.log('🎉 dar-estrellas.html cargado completamente');
        console.log('💡 Funciones disponibles:');
        console.log('  - showDebugInfo() - Ver info del sistema');
        console.log('  - getLastQR() - Obtener último QR generado');
        console.log('  - validateQR() - Validar formato QR');
        console.log('  - testConfirmation() - Probar modal de confirmación');
    </script>
</body>
</html>