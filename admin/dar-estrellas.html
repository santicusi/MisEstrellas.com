<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisEstrellas - Dar Estrellas</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <button class="back-btn" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 data-translate="give_stars">Dar Estrellas</h1>
                <div class="language-toggle">
                    <button class="lang-btn" onclick="changeLanguage('es')" id="lang-es">ES</button>
                    <button class="lang-btn" onclick="changeLanguage('en')" id="lang-en">EN</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Points Counter -->
            <div class="points-section">
                <div class="points-card">
                    <h2 data-translate="select_points">Seleccionar Puntos</h2>
                    <div class="points-counter">
                        <button class="counter-btn" onclick="decrementPoints()" id="decrement-btn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <div class="points-display">
                            <span class="points-number" id="points-number">1</span>
                            <i class="fas fa-star"></i>
                        </div>
                        <button class="counter-btn" onclick="incrementPoints()" id="increment-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="points-presets">
                        <button class="preset-btn" onclick="setPoints(1)">1</button>
                        <button class="preset-btn" onclick="setPoints(5)">5</button>
                        <button class="preset-btn" onclick="setPoints(10)">10</button>
                        <button class="preset-btn" onclick="setPoints(25)">25</button>
                    </div>
                </div>
            </div>

            <!-- Generate QR Section -->
            <div class="qr-section">
                <div class="qr-card">
                    <h2 data-translate="generate_qr">Generar Código QR</h2>
                    <div class="qr-container" id="qr-container">
                        <div class="qr-placeholder" id="qr-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <p data-translate="qr_placeholder">El código QR aparecerá aquí</p>
                            <button class="btn-primary" onclick="generateQR()" data-translate="create_qr">Crear QR</button>
                        </div>
                        <div class="qr-code-display" id="qr-code-display" style="display: none;">
                            <div class="qr-code" id="qr-code"></div>
                            <div class="qr-info">
                                <p class="qr-points">
                                    <i class="fas fa-star"></i>
                                    <span id="qr-points-display">1</span>
                                    <span data-translate="points">puntos</span>
                                </p>
                                <p class="qr-code-text" id="qr-code-text">ABC123</p>
                                <p class="qr-expires" data-translate="expires_in">Expira en: <span id="qr-expires-time">5:00</span></p>
                            </div>
                            <div class="qr-actions">
                                <button class="btn-secondary" onclick="regenerateQR()" data-translate="regenerate">Regenerar</button>
                                <button class="btn-secondary" onclick="clearQR()" data-translate="clear">Limpiar</button>
                            </div>
                        </div>
                        <div class="qr-loading" id="qr-loading" style="display: none;">
                            <div class="spinner"></div>
                            <p data-translate="generating_qr">Generando código QR...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions-section">
                <h3 data-translate="instructions">Instrucciones</h3>
                <div class="instructions-list">
                    <div class="instruction-item">
                        <div class="instruction-number">1</div>
                        <p data-translate="instruction_select">Selecciona la cantidad de puntos a otorgar</p>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">2</div>
                        <p data-translate="instruction_generate">Genera el código QR haciendo clic en "Crear QR"</p>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">3</div>
                        <p data-translate="instruction_scan">El cliente debe escanear el código con su aplicación</p>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">4</div>
                        <p data-translate="instruction_confirm">Confirma la transacción cuando aparezca la notificación</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="admin-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span data-translate="dashboard">Dashboard</span>
            </a>
            <a href="dar-estrellas.html" class="nav-item active">
                <i class="fas fa-star"></i>
                <span data-translate="give_stars">Dar Estrellas</span>
            </a>
            <a href="clientes.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span data-translate="clients">Clientes</span>
            </a>
            <a href="perfil-negocio.html" class="nav-item">
                <i class="fas fa-store"></i>
                <span data-translate="business_profile">Perfil</span>
            </a>
        </nav>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="confirm_transaction">Confirmar Transacción</h2>
            </div>
            <div class="modal-body">
                <div class="client-info">
                    <div class="client-avatar">
                        <img id="modal-client-avatar" src="../images/default-avatar.svg" alt="Cliente">
                    </div>
                    <div class="client-details">
                        <h3 id="modal-client-name">Cliente</h3>
                        <p id="modal-client-contact">+57 300 123 4567</p>
                    </div>
                </div>
                <div class="transaction-details">
                    <div class="transaction-item">
                        <span data-translate="points_to_give">Puntos a otorgar:</span>
                        <span class="transaction-value">
                            <i class="fas fa-star"></i>
                            <span id="modal-points">1</span>
                        </span>
                    </div>
                    <div class="transaction-item">
                        <span data-translate="business">Negocio:</span>
                        <span class="transaction-value" id="modal-business">Mi Negocio</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeConfirmationModal()" data-translate="cancel">Cancelar</button>
                    <button class="btn-primary" onclick="confirmTransaction()" data-translate="confirm">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="success">¡Éxito!</h2>
            </div>
            <div class="modal-body">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="success-message">
                    <p data-translate="transaction_completed">Transacción completada exitosamente</p>
                    <div class="success-details">
                        <p>
                            <span id="success-points">1</span>
                            <span data-translate="points_given_to">puntos otorgados a</span>
                            <span id="success-client">Cliente</span>
                        </p>
                    </div>
                </div>
                <button class="btn-primary" onclick="closeSuccessModal()" data-translate="continue">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="../js/translations.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    
    <script>
        let currentUser = null;
        let currentPoints = 1;
        let currentQRCode = null;
        let qrExpirationTimer = null;
        let businessData = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            updateTexts();
            loadBusinessData();
            updatePointsDisplay();
        });

        function checkAuthentication() {
            // [ESPACIO FIREBASE AUTH] - Check if admin is logged in
            currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = '../index.html';
                return;
            }
        }

        async function loadBusinessData() {
            try {
                // [ESPACIO FIREBASE] - Load business data
                businessData = await getBusinessData(currentUser.uid);
            } catch (error) {
                console.error('Error loading business data:', error);
            }
        }

        function incrementPoints() {
            if (currentPoints < 100) {
                currentPoints++;
                updatePointsDisplay();
                updateButtonStates();
            }
        }

        function decrementPoints() {
            if (currentPoints > 1) {
                currentPoints--;
                updatePointsDisplay();
                updateButtonStates();
            }
        }

        function setPoints(points) {
            currentPoints = points;
            updatePointsDisplay();
            updateButtonStates();
            
            // Highlight the selected preset
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        function updatePointsDisplay() {
            document.getElementById('points-number').textContent = currentPoints;
        }

        function updateButtonStates() {
            const decrementBtn = document.getElementById('decrement-btn');
            const incrementBtn = document.getElementById('increment-btn');
            
            decrementBtn.disabled = currentPoints <= 1;
            incrementBtn.disabled = currentPoints >= 100;
        }

        async function generateQR() {
            const qrPlaceholder = document.getElementById('qr-placeholder');
            const qrDisplay = document.getElementById('qr-code-display');
            const qrLoading = document.getElementById('qr-loading');
            
            // Show loading
            qrPlaceholder.style.display = 'none';
            qrDisplay.style.display = 'none';
            qrLoading.style.display = 'block';
            
            try {
                // [ESPACIO FIREBASE + QR] - Generate QR code
                const qrData = await crearQRPuntos(currentPoints, currentUser.uid);
                
                // Generate QR code
                const qrCodeElement = document.getElementById('qr-code');
                qrCodeElement.innerHTML = '';
                
                const qrCode = new QRCode(qrCodeElement, {
                    text: qrData.code,
                    width: 250,
                    height: 250,
                    colorDark: '#FF8C42',
                    colorLight: '#1A1A1A',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Update display
                document.getElementById('qr-points-display').textContent = currentPoints;
                document.getElementById('qr-code-text').textContent = qrData.displayCode;
                
                // Show QR display
                qrLoading.style.display = 'none';
                qrDisplay.style.display = 'block';
                
                // Set expiration timer
                startExpirationTimer(qrData.expiresIn);
                
                // Store current QR data
                currentQRCode = qrData;
                
                // Listen for QR scans
                listenForQRScans(qrData.id);
                
            } catch (error) {
                console.error('Error generating QR:', error);
                qrLoading.style.display = 'none';
                qrPlaceholder.style.display = 'block';
                showError(error.message);
            }
        }

        function startExpirationTimer(expiresIn) {
            let timeLeft = expiresIn;
            const timerElement = document.getElementById('qr-expires-time');
            
            qrExpirationTimer = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(qrExpirationTimer);
                    expireQR();
                }
            }, 1000);
        }

        function expireQR() {
            clearQR();
            showError(t('qr_expired'));
        }

        function regenerateQR() {
            clearQR();
            generateQR();
        }

        function clearQR() {
            const qrPlaceholder = document.getElementById('qr-placeholder');
            const qrDisplay = document.getElementById('qr-code-display');
            
            qrDisplay.style.display = 'none';
            qrPlaceholder.style.display = 'block';
            
            // Clear timer
            if (qrExpirationTimer) {
                clearInterval(qrExpirationTimer);
                qrExpirationTimer = null;
            }
            
            // Clear QR data
            currentQRCode = null;
        }

        async function listenForQRScans(qrId) {
            // [ESPACIO FIREBASE] - Listen for QR scan events
            console.log('Listening for QR scans:', qrId);
            
            // This would be implemented with Firebase real-time listeners
            // For now, we'll simulate it
            // onQRScanned would be called when a client scans the QR
        }

        function onQRScanned(clientData) {
            // Called when a client scans the QR code
            showConfirmationModal(clientData);
        }

        function showConfirmationModal(clientData) {
            const modal = document.getElementById('confirmation-modal');
            
            // Populate modal with client data
            document.getElementById('modal-client-name').textContent = clientData.name || 'Cliente';
            document.getElementById('modal-client-contact').textContent = clientData.phone || clientData.email;
            document.getElementById('modal-client-avatar').src = clientData.avatar || '../images/default-avatar.svg';
            document.getElementById('modal-points').textContent = currentPoints;
            document.getElementById('modal-business').textContent = businessData?.name || 'Mi Negocio';
            
            modal.style.display = 'block';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        async function confirmTransaction() {
            try {
                // [ESPACIO FIREBASE] - Process transaction
                await confirmarPuntos(currentQRCode.id, currentPoints);
                
                closeConfirmationModal();
                showSuccessModal();
                clearQR();
                
            } catch (error) {
                console.error('Error confirming transaction:', error);
                showError(error.message);
            }
        }

        function showSuccessModal() {
            const modal = document.getElementById('success-modal');
            
            document.getElementById('success-points').textContent = currentPoints;
            document.getElementById('success-client').textContent = document.getElementById('modal-client-name').textContent;
            
            modal.style.display = 'block';
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').style.display = 'none';
        }

        function showError(message) {
            alert(message);
        }

        function getCurrentUser() {
            // [ESPACIO FIREBASE AUTH] - Get current authenticated user
            return null;
        }

        // [ESPACIO FIREBASE + QR] - Firebase functions to implement
        async function crearQRPuntos(puntos, businessId) {
            // Generate QR code data and store in Firebase
            const qrId = generateId();
            const code = `POINTS:${businessId}:${qrId}:${puntos}`;
            const displayCode = qrId.substring(0, 8).toUpperCase();
            
            console.log('Creating QR for points:', puntos, 'business:', businessId);
            
            return {
                id: qrId,
                code: code,
                displayCode: displayCode,
                points: puntos,
                expiresIn: 300, // 5 minutes
                businessId: businessId
            };
        }

        async function confirmarPuntos(qrId, points) {
            // Process the transaction in Firebase
            console.log('Confirming transaction:', qrId, points);
        }

        async function getBusinessData(businessId) {
            // Get business data from Firebase
            return {
                name: 'Mi Negocio',
                type: 'Restaurante'
            };
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const confirmationModal = document.getElementById('confirmation-modal');
            const successModal = document.getElementById('success-modal');
            
            if (event.target === confirmationModal) {
                closeConfirmationModal();
            }
            
            if (event.target === successModal) {
                closeSuccessModal();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (qrExpirationTimer) {
                clearInterval(qrExpirationTimer);
            }
        });
    </script>
</body>
</html>
